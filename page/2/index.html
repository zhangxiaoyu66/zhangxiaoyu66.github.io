<!DOCTYPE html>
<html lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no">
<meta name="author" content="爱吃鱼的呆先生">


    
    


<meta property="og:type" content="website">
<meta property="og:title" content="爱吃鱼的呆先生">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="爱吃鱼的呆先生">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="爱吃鱼的呆先生">

<link rel="apple-touch-icon" href="/apple-touch-icon.png">


    <link rel="alternate" href="/atom.xml" title="爱吃鱼的呆先生" type="application/atom+xml">



    <link rel="shortcut icon" href="/favicon.png">



    <link href="//cdn.bootcss.com/animate.css/3.5.1/animate.min.css" rel="stylesheet">



    <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">


<link rel="stylesheet" href="/css/style.css">


    <style> .article { opacity: 0;} </style>


<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>爱吃鱼的呆先生</title>

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: true,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: false
    }
</script>


    <script> yiliaConfig.jquery_ui = [false]; </script>



    <script> yiliaConfig.rootUrl = "\/";</script>






</head></html>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/img/avatar.jpg" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">爱吃鱼的呆先生</a></h1>
        </hgroup>

        

        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/">标签云与分类</a></li>
                        
                            <li><a href="/pdfdocuments/">pdf文档笔记</a></li>
                        
                            <li><a href="/about/">关于我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="https://mail.163.com/" title="Email"></a>
                            
                                <a class="fa CSDN" href="https://www.csdn.net/" title="CSDN"></a>
                            
                                <a class="fa Coding" href="https://coding.net/login" title="Coding"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ElasticSearch/">ElasticSearch</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Git/">Git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Idea/">Idea</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Json/">Json</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Logstash/">Logstash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MyBatisPlus/">MyBatisPlus</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL基础/">MySQL基础</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/">Redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring-Cloud/">Spring Cloud</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringDataJPA/">SpringDataJPA</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/String/">String</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Zookeeper/">Zookeeper</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/easyExcel/">easyExcel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mybatis/">mybatis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据结构/">数据结构</a></li></ul>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a class="main-nav-link switch-friends-link" href="https://hexo.io">Hexo</a>
                    
                      <a class="main-nav-link switch-friends-link" href="https://pages.github.com/">GitHub</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://moxfive.xyz/">MOxFIVE</a>
                    
                      <a class="main-nav-link switch-friends-link" href="https://mybatis.org/mybatis-3/zh/index.html">Mybatis</a>
                    
                      <a class="main-nav-link switch-friends-link" href="https://spring.io/projects/spring-framework#overview">Spring</a>
                    
                      <a class="main-nav-link switch-friends-link" href="https://spring.io/projects/spring-boot">SpringBoot</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">真正的大师永远保持一颗学徒的心</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">爱吃鱼的呆先生</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/img/avatar.jpg" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">爱吃鱼的呆先生</a></h1>
            </hgroup>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/">标签云与分类</a></li>
                
                    <li><a href="/pdfdocuments/">pdf文档笔记</a></li>
                
                    <li><a href="/about/">关于我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="https://mail.163.com/" title="Email"></a>
                            
                                <a class="fa CSDN" target="_blank" href="https://www.csdn.net/" title="CSDN"></a>
                            
                                <a class="fa Coding" target="_blank" href="https://coding.net/login" title="Coding"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="标签" friends="友情链接" about="关于我"/>
</nav>
      <div class="body-wrap">
  
    <article id="post-数据结构/动态规划" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2020/04/23/数据结构/动态规划/" class="article-date">
      <time datetime="2020-04-23T06:56:27.409Z" itemprop="datePublished">2020-04-23</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>动态规划</p>
<p>斐波那契数列Fibonacci Sequence</p>
<p>F(0)=1，F(1)=1，F(n)=F(n-1)+F(n-2)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fib</span><span class="params">(<span class="keyword">int</span> n)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(n==<span class="number">0</span>)&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(n==<span class="number">1</span>)&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> fib(n<span class="number">-1</span>)+fib(n<span class="number">-2</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>记忆化搜索</p>
<p>自上向下的解决问题</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Json/Json" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2020/04/21/Json/Json/" class="article-date">
      <time datetime="2020-04-21T04:48:18.642Z" itemprop="datePublished">2020-04-21</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/21/Json/Json/">Json详解以及fastjson使用教程</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="Json详解以及fastjson使用教程"><a href="#Json详解以及fastjson使用教程" class="headerlink" title="Json详解以及fastjson使用教程"></a>Json详解以及fastjson使用教程</h1><p>Json是一种轻量级的数据交换格式，采用一种“键：值”对的文本格式来存储和表示数据，在系统交换数据过程中常常被使用，是一种理想的数据交换语言。在使用Java做Web开发时，不可避免的会遇到Json的使用。下面我们就简单讲一下Json的使用以及fastjson.jar包的使用。</p>
<h2 id="JSON形式与语法"><a href="#JSON形式与语法" class="headerlink" title="JSON形式与语法"></a>JSON形式与语法</h2><h3 id="JSON对象"><a href="#JSON对象" class="headerlink" title="JSON对象"></a>JSON对象</h3><p>我们先来看以下数据</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"ID"</span>: <span class="number">1001</span>,</span><br><span class="line">	<span class="attr">"name"</span>: <span class="string">"张三"</span>,</span><br><span class="line">	<span class="attr">"age"</span>: <span class="number">24</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一个数据就是一个Json对象，观察它的数据形式，可以得出以下语法：</p>
<p>1：数据在花括号中</p>
<p>2：数据以”键：值”对的形式出现（其中键多以字符串形式出现，值可取字符串，数值，甚至其他json对象）</p>
<p>3：每两个”键：值”对以逗号分隔（最后一个”键：值”对省略逗号）</p>
<p>遵守上面3点，便可以形成一个json对象。</p>
<h3 id="JSON对象数组"><a href="#JSON对象数组" class="headerlink" title="JSON对象数组"></a>JSON对象数组</h3><p>接下来我们再看第二个数据，观察它的数据形式，可以得出以下语法</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">	&#123;<span class="attr">"ID"</span>: <span class="number">1001</span>, <span class="attr">"name"</span>: <span class="string">"张三"</span>, <span class="attr">"age"</span>: <span class="number">24</span>&#125;,</span><br><span class="line">	&#123;<span class="attr">"ID"</span>: <span class="number">1002</span>, <span class="attr">"name"</span>: <span class="string">"李四"</span>, <span class="attr">"age"</span>: <span class="number">25</span>&#125;,</span><br><span class="line">	&#123;<span class="attr">"ID"</span>: <span class="number">1003</span>, <span class="attr">"name"</span>: <span class="string">"王五"</span>, <span class="attr">"age"</span>: <span class="number">22</span>&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>1：数据在方括号中（可理解为数组）</p>
<p>2：方括号中每个数据以json对象形式出现</p>
<p>3：每两个数据以逗号分隔（最后一个无需逗号）</p>
<p>遵守上面3点，便可形成一个json对象数组（及一个数组中，存储了多个json对象）</p>
<p>理解了上面两种基本的形式，我们就可以得出其他的数据形式，例如下面这个：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"部门名称"</span>:<span class="string">"研发部"</span>,</span><br><span class="line">	<span class="attr">"部门成员"</span>:[</span><br><span class="line">	&#123;<span class="attr">"ID"</span>: <span class="number">1001</span>, <span class="attr">"name"</span>: <span class="string">"张三"</span>, <span class="attr">"age"</span>: <span class="number">24</span>&#125;,</span><br><span class="line">	&#123;<span class="attr">"ID"</span>: <span class="number">1002</span>, <span class="attr">"name"</span>: <span class="string">"李四"</span>, <span class="attr">"age"</span>: <span class="number">25</span>&#125;,</span><br><span class="line">	&#123;<span class="attr">"ID"</span>: <span class="number">1003</span>, <span class="attr">"name"</span>: <span class="string">"王五"</span>, <span class="attr">"age"</span>: <span class="number">22</span>&#125;],</span><br><span class="line">	<span class="attr">"部门位置"</span>:<span class="string">"xx楼21号"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这是上面两个基本形式结合出来的一种变形，通过这种变形，使得数据的封装具有很大的灵活性，能让开发者自由的发挥想象力。</p>
<h3 id="JSON字符串"><a href="#JSON字符串" class="headerlink" title="JSON字符串"></a>JSON字符串</h3><p>JSON字符串也是在平时开发中使用较多的，json字符串应满足以下条件：</p>
<p>1：它必须是一个字符串，由” “或者’ ‘包裹数据，支持字符串的各种操作</p>
<p>2：里面的数据格式应该要满足其中一个格式，可以是json对象，也可以是json对象数组或者是两种基本形式的组合变形。</p>
<p>总结：json可以简单的分为基本形式：json对象，json对象数组。两种基本格式组合变形出其他的形式，但其本质还是json对象或者json对象数组中的一种。json对象或对象数组可以转化为json字符串，使用于不同的场合。</p>
<p>注意点：在封装json数据的时候，很容易出现错误，比如粗心的在最后一条数据的末尾加上了逗号等等，这里我提供一个在线验证工具，方便大家验证json数据格式的正确性</p>
<p><a href="http://www.bejson.com/" target="_blank" rel="noopener">http://www.bejson.com/</a></p>
<h2 id="fastjson介绍与使用"><a href="#fastjson介绍与使用" class="headerlink" title="fastjson介绍与使用"></a>fastjson介绍与使用</h2><h3 id="fastjson简介与jar下载"><a href="#fastjson简介与jar下载" class="headerlink" title="fastjson简介与jar下载"></a>fastjson简介与jar下载</h3><p>fastjson.jar是阿里爸爸开发的一款专门用于Java开发的包，可以方便的实现json对象与JavaBean对象的转换，实现JavaBean对象与json字符串的转换，实现json对象与json字符串的转换。除了这个fastjson以外，还有Google开发的Gson包，其他形式的如net.sf.json包，都可以实现json的转换。方法名称不同而已，最后的实现结果都是一样的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">将json字符串转化为json对象</span><br><span class="line">在net.sf.json中是这么做的</span><br><span class="line">JSONObject obj = <span class="keyword">new</span> JSONObject().fromObject(jsonStr);<span class="comment">//将json字符串转换为json对象</span></span><br><span class="line"> </span><br><span class="line">在fastjson中是这么做的</span><br><span class="line">JSONObject obj=JSON.parseObject(jsonStr);<span class="comment">//将json字符串转换为json对象</span></span><br></pre></td></tr></table></figure>

<p>今天我们主要讲fastjson的使用，首先应该在Java工程中导入对应的fastjson.jar包，fastjson.jar包原始下载地址：<a href="https://github.com/alibaba/fastjson，点击页面中的download即可下载最新的包" target="_blank" rel="noopener">https://github.com/alibaba/fastjson，点击页面中的download即可下载最新的包</a></p>
<p>fastjson.jar包百度云盘下载地址：<a href="https://pan.baidu.com/s/1CCGoRCdSjNUDB736cRCDBw" target="_blank" rel="noopener">https://pan.baidu.com/s/1CCGoRCdSjNUDB736cRCDBw</a></p>
<h3 id="fastjson源码分析与使用"><a href="#fastjson源码分析与使用" class="headerlink" title="fastjson源码分析与使用"></a>fastjson源码分析与使用</h3><p>在包中，可以发现主要的3个类，JSON,JSONArray，JSONObject</p>
<p>三者之间的关系如下，JSONObject和JSONArray继承JSON</p>
<p><img src="/2020/04/21/Json/Json/image-20200421124732824.png" alt="image-20200421124732824"></p>
<p>如果你们看不到源代码，请参考另一篇博客，先安装Java反编译工具：</p>
<p><a href="https://blog.csdn.net/srj1095530512/article/details/81587601" target="_blank" rel="noopener">https://blog.csdn.net/srj1095530512/article/details/81587601</a></p>
<p>联系上面讲到的json基础知识并对应这三个类，可以发现，JSONObject代表json对象，JSONArray代表json对象数组，JSON代表JSONObject和JSONArray的转化。</p>
<h4 id="JSONObject类源码分析与使用"><a href="#JSONObject类源码分析与使用" class="headerlink" title="JSONObject类源码分析与使用"></a>JSONObject类源码分析与使用</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JSONObject</span> <span class="keyword">extends</span> <span class="title">JSON</span> <span class="keyword">implements</span> <span class="title">Map</span>&lt;<span class="title">String</span>, <span class="title">Object</span>&gt;, <span class="title">Cloneable</span>, <span class="title">Serializable</span>, <span class="title">InvocationHandler</span> </span>&#123;</span><br></pre></td></tr></table></figure>

<p>观察该类的继承与实现关系，不难发现，JSONObject实现了Map接口，而json对象中的数据都是以”键：值”对形式出现，可以猜想，    JSONObject底层操作是由Map实现的。</p>
<p>再来看类中的主要方法：</p>
<p><img src="/2020/04/21/Json/Json/1.png" alt></p>
<p>类中主要是get()方法。因为JSONObject相当于json对象，所以该类中主要封装了各种get方法，通过”键：值”对中的键来获取其对应的值。且方法的输入参数几乎皆为String类型，这是因为json对象中，”键：值”对的键都是String类型的。</p>
<p>来看一下平时用到较多的getString(String key)方法，该方法输入参数为String key（键），输出为String ，用于获取json对象中的字符串型数据。例如通过该方法获取  “name”：”bob”键值对中name这个键所对应的值bob。</p>
<p><img src="/2020/04/21/Json/Json/3.png" alt></p>
<p>看其源码，可以发现，内部主要是由get（key）方法实现，找到这个方法如下：</p>
<p><img src="/2020/04/21/Json/Json/4.png" alt></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>  DEFAULT_INITIAL_CAPACITY = <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; map;</span><br></pre></td></tr></table></figure>

<p>发现内部主要由Map接口中的get()方法实现</p>
<p>再去看JSONObject中另一个常用的方法getInteger(String key)，该方法获取json对象中的整型数据，例如获取”age：20”键值对中age对应的整型数值20.</p>
<p><img src="/2020/04/21/Json/Json/5.png" alt></p>
<p>对比getString(String key)方法，两者极为相似，都是通过Map接口的get()方法实现</p>
<p>再看几个其他的方法，也是由Map接口中的相应方法实现的，这里不再赘述</p>
<p><img src="/2020/04/21/Json/Json/6.png" alt></p>
<p>总结：JSONObject对应json对象，通过各种形式的get()方法可以获取json对象中的数据，也可利用诸如size()，isEmpty()等方法获取”键：值”对的个数和判断是否为空。其本质是通过实现Map接口并调用接口中的方法完成的</p>
<h4 id="JSONArray类源码分析与使用"><a href="#JSONArray类源码分析与使用" class="headerlink" title="JSONArray类源码分析与使用"></a>JSONArray类源码分析与使用</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JSONArray</span> <span class="keyword">extends</span> <span class="title">JSON</span> <span class="keyword">implements</span> <span class="title">List</span>&lt;<span class="title">Object</span>&gt;, <span class="title">Cloneable</span>, <span class="title">RandomAccess</span>, <span class="title">Serializable</span> </span>&#123;</span><br></pre></td></tr></table></figure>

<p>观察JSONArray的继承与实现，并结合上面对JSONObject的分析，不难发现，其内部是有List接口中的方法来完成操作的</p>
<p>同样观察JSONArray类中的方法，由于方法较多，下面分为两部分</p>
<p><img src="/2020/04/21/Json/Json/20180908175047521.png" alt="img"></p>
<p>首先来明确一点，因为JSONArray代表json对象数组，json数组对象中存储的是一个个json对象，所以类中的方法主要用于直接操作json对象。比如这其中的add(),remove()，containsAll()方法，对应于json对象的添加，删除与判断。</p>
<p><img src="/2020/04/21/Json/Json/20180908175611602.png" alt></p>
<p>其内部主要有List接口中的对应方法来实现。</p>
<p>跟JSONObject一样，JSONArray里面也有一些get()方法，不过都不常用，最有用的应该是getJSONObject(int index)方法，该方法用于获取json对象数组中指定位置的JSONObject对象，配合size()方法，可用于遍历json对象数组中的各个对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> JSONObject <span class="title">getJSONObject</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">        Object value = list.get(index);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (value <span class="keyword">instanceof</span> JSONObject) &#123;</span><br><span class="line">            <span class="keyword">return</span> (JSONObject) value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Map) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> JSONObject((Map) value);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (JSONObject) toJSON(value);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/04/21/Json/Json/20180908180148667.png" alt></p>
<p>通过以上两个方法，在配合for循环，即可实现json对象数组的遍历，当然JSONArray中也实现了迭代器方法来遍历，这和List的遍历极为相似</p>
<p><img src="/2020/04/21/Json/Json/20180908180430227.png" alt></p>
<p>通过遍历得到JSONObject对象，然后再利用JSONObject类中的get()方法，即可实现最终json数据的获取！！！</p>
<p>好了，接下来我们看最后一个，也是最重要的一个类JSON类。之所以把这个放在最后，是因为这个类主要是实现转化用的，最后的数据获取，还是要通过上面的JSONObject和JSONArray来实现。</p>
<h3 id="JSON类源码分析与使用"><a href="#JSON类源码分析与使用" class="headerlink" title="JSON类源码分析与使用"></a>JSON类源码分析与使用</h3><p>先来看一下这个类中的主要方法，方法比较多，也分为两部分</p>
<p><img src="/2020/04/21/Json/Json/20180908181709573.png" alt></p>
<p><img src="/2020/04/21/Json/Json/20180908181749212.png" alt></p>
<p>仔细观察这些方法，主要是实现json对象，json对象数组，javabean对象，json字符串之间的相互转化</p>
<p>JSON类之toJSONString()方法，实现json对象转化为json字符串和javabean对象转化为json 字符串</p>
<p><img src="/2020/04/21/Json/Json/2018090818232048.png" alt></p>
<p>该方法经过多次重载，但最终都是实现json对象转化为json字符串和javabean对象转化为json 字符串。其中，有关键字transient修饰的toJSONString()用于json对象序列化过程中，希望某个”键：值”对数据不变的应用中</p>
<p><strong>JSON类之parseObject()方法，实现json字符串转换为json对象或javabean对象</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JSONObject <span class="title">parseObject</span><span class="params">(String text)</span> </span>&#123;</span><br><span class="line">        Object obj = parse(text);</span><br><span class="line">        <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> JSONObject) &#123;</span><br><span class="line">            <span class="keyword">return</span> (JSONObject) obj;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (JSONObject) JSON.toJSON(obj);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">"can not cast to JSONObject."</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">parse</span><span class="params">(String text)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> parse(text, DEFAULT_PARSER_FEATURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.2.38</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">parse</span><span class="params">(String text, ParserConfig config)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> parse(text, config, DEFAULT_PARSER_FEATURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.2.38</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">parse</span><span class="params">(String text, ParserConfig config, <span class="keyword">int</span> features)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (text == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    DefaultJSONParser parser = <span class="keyword">new</span> DefaultJSONParser(text, config, features);</span><br><span class="line">    Object value = parser.parse();</span><br><span class="line"></span><br><span class="line">    parser.handleResovleTask(value);</span><br><span class="line"></span><br><span class="line">    parser.close();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">parse</span><span class="params">(String text, <span class="keyword">int</span> features)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> parse(text, ParserConfig.getGlobalInstance(), features);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该方法返回JSONObject对象，用于实现json字符串向json对象的转化，其内部调用了parse()方法，调用底层的DefaultJSONParser解析类进行转化，在转化失败时，抛出can not cast to JSONObject异常。</p>
<p>该方法不仅能实现json字符串向json对象的转化,经过重载之后，还能实现json字符串向javabean对象的转化</p>
<p><img src="/2020/04/21/Json/Json/20180908184006503.jpg" alt></p>
<p>json字符串与javaBean之间的转换可以使用 TypeReference<t> 这个类，也可以使用Class这个类。</t></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Student stu1=JSON.parseObject(jsonstr,new TypeReference&lt;Student&gt;()&#123;&#125;);</span><br><span class="line">Student stu1=JSON.parseObject(jsonstr,Student.class);</span><br></pre></td></tr></table></figure>

<p>我推荐使用第二种Class类反射来实现，比较简单</p>
<p><strong>JSON类之JSONArray()方法，实现json字符串转化为json对象数组或List<t></t></strong></p>
<p>与parseObject()方法类似，parseArray()将json字符串转化为json对象数组或转化成包含泛型的List</p>
<p><img src="/2020/04/21/Json/Json/2018090818574391.jpg" alt></p>
<p><strong>JSON类之toJSON()方法，实现javabean对象转化为json对象</strong></p>
<p>该方法用的比较少，主要用于将javabean对象转化为json对象，内部通过Map，LinkedHashMap，HashMap等集合接口实现。</p>
<p><img src="/2020/04/21/Json/Json/20180908190110340.png" alt></p>
<p><strong>JSON类之toJavaObject()方法，实现json对象转化为javabean对象</strong></p>
<p>该方法也经过重载，通过TypeReference类和Class类反射来实现，主要讲json对象转化为javabean对象，用的也比较少。</p>
<p><img src="/2020/04/21/Json/Json/20180908190452769.png" alt></p>
<p>至此，JSON类中的方法也讲解的差不多了，下面给出Java实例来实现以上的各种转换</p>
<p>测试类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jsonTest;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONArray;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.TypeReference;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyJson</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">		List&lt;Student&gt; list=<span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		Student student=<span class="keyword">new</span> Student(<span class="string">"bob"</span>,<span class="number">24</span>);</span><br><span class="line">		Student student12=<span class="keyword">new</span> Student(<span class="string">"lily"</span>, <span class="number">23</span>);</span><br><span class="line">		list.add(student);</span><br><span class="line">		list.add(student12);</span><br><span class="line">		System.out.println(<span class="string">"*******javaBean  to jsonString*******"</span>);</span><br><span class="line">		String str1=JSON.toJSONString(student);</span><br><span class="line">		System.out.println(str1);</span><br><span class="line">		System.out.println(JSON.toJSONString(list));</span><br><span class="line">		System.out.println();</span><br><span class="line">		</span><br><span class="line">		System.out.println(<span class="string">"******jsonString to javaBean*******"</span>);</span><br><span class="line">		<span class="comment">//Student stu1=JSON.parseObject(str1,new TypeReference&lt;Student&gt;()&#123;&#125;);</span></span><br><span class="line">		Student stu1=JSON.parseObject(str1,Student.class);</span><br><span class="line">		System.out.println(stu1);</span><br><span class="line">		System.out.println();</span><br><span class="line">		</span><br><span class="line">		System.out.println(<span class="string">"******javaBean to jsonObject******"</span>);</span><br><span class="line">		JSONObject jsonObject1=(JSONObject)JSON.toJSON(student);</span><br><span class="line">		System.out.println(jsonObject1.getString(<span class="string">"name"</span>));</span><br><span class="line">		System.out.println();</span><br><span class="line">		</span><br><span class="line">		System.out.println(<span class="string">"******jsonObject to javaBean******"</span>);</span><br><span class="line">		Student student2=JSON.toJavaObject(jsonObject1, Student.class);</span><br><span class="line">		System.out.println(student2);</span><br><span class="line">		System.out.println();</span><br><span class="line">		</span><br><span class="line">		System.out.println(<span class="string">"*******javaBean to jsonArray******"</span>);</span><br><span class="line">		List&lt;Student&gt; stulist=<span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)&#123;</span><br><span class="line">			stulist.add(<span class="keyword">new</span> Student(<span class="string">"student"</span>+i, i));</span><br><span class="line">			</span><br><span class="line">		&#125;</span><br><span class="line">		JSONArray jsonArrays=(JSONArray)JSON.toJSON(stulist);</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;jsonArrays.size();i++)&#123;</span><br><span class="line">		System.out.println(jsonArrays.getJSONObject(i));</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println();</span><br><span class="line">		</span><br><span class="line">		System.out.println(<span class="string">"*****jsonArry to javalist******"</span>);</span><br><span class="line">		List&lt;Student&gt; myList=<span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;jsonArrays.size();i++)&#123;</span><br><span class="line">			</span><br><span class="line">		Student student3=JSON.toJavaObject(jsonArrays.getJSONObject(i), Student.class);</span><br><span class="line">			myList.add(student3);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span>(Student stu:myList)&#123;</span><br><span class="line">			System.out.println(stu);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	        System.out.println();</span><br><span class="line">		</span><br><span class="line">		System.out.println(<span class="string">"*****jsonObject to jsonString*****"</span>);</span><br><span class="line">		String str4=JSON.toJSONString(jsonObject1);</span><br><span class="line">		System.out.println(str4);</span><br><span class="line">		System.out.println();</span><br><span class="line">		</span><br><span class="line">		System.out.println(<span class="string">"*******jsonString to jsonObject*****"</span>);</span><br><span class="line">		JSONObject jso1=JSON.parseObject(str1);</span><br><span class="line">		System.out.println(jso1.getString(<span class="string">"name"</span>));</span><br><span class="line">		System.out.println();</span><br><span class="line">		</span><br><span class="line">		System.out.println(<span class="string">"*****jsonString to jsonArray*****"</span>);</span><br><span class="line">		JSONArray jArray=JSON.parseArray(JSON.toJSONString(stulist));</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;jArray.size();i++)&#123;</span><br><span class="line">		System.out.println(jArray.getJSONObject(i));</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试类对应的javabean类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jsonTest;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Student</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated constructor stub</span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Student</span><span class="params">(String name,<span class="keyword">int</span> age)</span></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.name=name;</span><br><span class="line">		<span class="keyword">this</span>.age=age;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.name=name;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> name;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.age=age;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> age;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		<span class="keyword">return</span> <span class="string">"student [name="</span>+name+<span class="string">" , "</span>+<span class="string">"age="</span>+age+<span class="string">"]"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Json/">Json</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Json/">Json</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-SpringMVC/SpringMVC" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2020/04/18/SpringMVC/SpringMVC/" class="article-date">
      <time datetime="2020-04-18T10:59:40.395Z" itemprop="datePublished">2020-04-18</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="SpringMVC"><a href="#SpringMVC" class="headerlink" title="SpringMVC"></a>SpringMVC</h1><h2 id="课堂目标"><a href="#课堂目标" class="headerlink" title="课堂目标"></a>课堂目标</h2><ul>
<li><p>熟悉springmvc六大组件的作用及使用方式</p>
</li>
<li><p>掌握搭建ssm开发框架</p>
</li>
<li><p>掌握springmvc对于返回值的处理</p>
</li>
<li><p>掌握springmvc对于参数的处理</p>
</li>
<li><p>理解REST和RESTful，掌握springmvc对于RESTful的支持</p>
</li>
<li><p>掌握springmvc拦截器的应用</p>
</li>
<li><p>掌握springmvc中基于cors的跨域解决方案</p>
</li>
<li><p>掌握spring中的父子容器</p>
</li>
<li><p>了解springmvc的mock测试</p>
</li>
<li><p>了解ControllerAdvice类的开发ModelAttribute、InitBinder、ExceptionHandler</p>
</li>
<li><p>了解springmvc异常处理器</p>
</li>
<li><p>了解springmvc中的get\post请求乱码和响应乱码处理</p>
</li>
<li><p>了解springmvc中非注解开发方式</p>
</li>
</ul>
<h2 id="介绍篇"><a href="#介绍篇" class="headerlink" title="介绍篇"></a>介绍篇</h2><h3 id="基础概念介绍"><a href="#基础概念介绍" class="headerlink" title="基础概念介绍"></a>基础概念介绍</h3><h4 id="BS和CS开发架构"><a href="#BS和CS开发架构" class="headerlink" title="BS和CS开发架构"></a>BS和CS开发架构</h4><p>一种是C/S 架构，也就是客户端/服务器</p>
<p>一种是B/S 架构 ，也就是浏览器/服务器架构 </p>
<blockquote>
<p>说明：<br>我们现在使用Java开发的大多数都是web应用 ，这些应用几乎全都是基于B/S 架构进行开发的。那么在B/S<br>架构中，应用系统标准的三层架构分为：表现层、业务层、持久层 。这种三层架构在我们的实际开发中使用的非常多，所以我们课程中的案例也都是基于三层架构设计的。</p>
</blockquote>
<p>JavaEE制定了一套规范，去进行BS结构的处理。这套规范就是Servlet 。</p>
<h4 id="应用系统三层架构"><a href="#应用系统三层架构" class="headerlink" title="应用系统三层架构"></a>应用系统三层架构</h4><h5 id="表现层："><a href="#表现层：" class="headerlink" title="表现层："></a>表现层：</h5><ul>
<li>也就是我们常说的web 层 。</li>
<li>它负责接收客户端请求，向客户端响应结果 ，通常客户端使用http 协议请求web 层，web 层需要接收http 请求，完成http 响应。</li>
<li>表现层包括展示层和控制层 ：控制层负责接收请求，展示层负责结果的展示。</li>
<li>表现层依赖业务层，接收到客户端请求一般会调用业务层进行业务处理，并将处理结果响应给客户端。</li>
<li>表现层的设计一般都使用 MVC 模型 。（MVC 是表现层的设计模型，和其他层没有关系）</li>
</ul>
<h5 id="业务层-："><a href="#业务层-：" class="headerlink" title="业务层 ："></a>业务层 ：</h5><ul>
<li><p>也就是我们常说的service 层。</p>
</li>
<li><p>它负责业务逻辑处理，和我们开发项目的需求息息相关。web 层依赖业务层，但是业务层不依赖web层。</p>
</li>
<li><p>业务层在业务处理时可能会依赖持久层，如果要对数据持久化需要保证事务一致性。（也就是我们说的，<br>事务应该放到业务层来控制）</p>
</li>
</ul>
<h5 id="持久层"><a href="#持久层" class="headerlink" title="持久层 :"></a>持久层 :</h5><ul>
<li>也就是我们是常说的dao 层。</li>
<li>负责数据持久化，包括数据层即数据库和数据访问层，数据库是对数据进行持久化的载体，数据访问层是<br>业务层和持久层交互的接口，业务层需要通过数据访问层将数据持久化到数据库中。</li>
<li>通俗的讲，持久层就是和数据库交互，对数据库表进行增删改查的。</li>
</ul>
<h4 id="MVC设计模式"><a href="#MVC设计模式" class="headerlink" title="MVC设计模式"></a>MVC设计模式</h4><p>MVC<br>是模型(model)－视图(view)－控制器(controller) 的缩写，是一种用于设计编写Web 应用程序表现层的模式。</p>
<p>MVC 设计模式的三大角色：</p>
<ul>
<li><p>Model（模型）：</p>
<p>模型包含业务模型和数据模型 ，数据模型用于封装数据，业务模型用于处理业务。</p>
</li>
<li><p>View（视图）：</p>
<p>通常指的就是我们的jsp 或者html。作用一般就是展示数据的。</p>
<p>通常视图是依据数据模型创建的。</p>
</li>
<li><p>Controller（控制器）：</p>
<p>是应用程序中处理用户交互的部分。作用一般就是处理程序逻辑的。</p>
</li>
</ul>
<h3 id="SpringMVC介绍"><a href="#SpringMVC介绍" class="headerlink" title="SpringMVC介绍"></a>SpringMVC介绍</h3><h4 id="SpringMVC是什么"><a href="#SpringMVC是什么" class="headerlink" title="SpringMVC是什么"></a>SpringMVC是什么</h4><ul>
<li>SpringMVC 是一种基于MVC 设计模型的请求驱动类型的轻量级 Web 框架 ，属于SpringFrameWork 的后续<br>产品，已经融合在Spring Web Flow 里面。Spring 框架提供了构建Web 应用程序的全功能MVC 模块。</li>
<li>使用Spring 可插入的MVC 架构，从而在使用Spring 进行WEB 开发时，可以选择使用Spring 的Spring MVC 框架或集成其他MVC 开发框架，如Struts1(现在一般不用)，Struts2 等。</li>
<li>SpringMVC 已经成为目前最主流的 MVC 框架 之一，并且随着 Spring3.0 的发布，全面超越 Struts2，成为最优秀的 MVC 框架。</li>
<li>它通过一套注解，让一个简单的Java 类成为处理请求的控制器，而无须实现任何接口。同时它还支持RESTful 编程风格的请求。</li>
</ul>
<h4 id="SpringMVC与Spring的联系"><a href="#SpringMVC与Spring的联系" class="headerlink" title="SpringMVC与Spring的联系"></a>SpringMVC与Spring的联系</h4><p>Spring MVC 全名叫Spring Web MVC ，它是Spring家族Web模块的一个重要成员。这一点,我们可以从Spring 的整体结构中看得出来：</p>
<img src="/2020/04/18/SpringMVC/SpringMVC/image-20200418194902816.png" alt="image-20200418194902816" style="zoom: 80%;">

<h4 id="为什么学习SpringMVC"><a href="#为什么学习SpringMVC" class="headerlink" title="为什么学习SpringMVC"></a>为什么学习SpringMVC</h4><p>也许你要问，为什么要学习Spring MVC呢？Struts2不才是主流吗？看SSH的概念有多火？</p>
<p>其实很多初学者混淆了一个概念，SSH 实际上指的是Struts1.x+Spring+Hibernate 。这个概念已经有十几年的历<br>史了。在Struts1.x时代，它是当之无愧的霸主，但是在新的MVC框架涌现的时代，形式已经不是这样了，<br>Struts2.x借助了Struts1.x的好名声，让国内开发人员认为Struts2.x是霸主继任者（其实两者在技术上无任何关<br>系），导致国内程序员大多数学习基于Struts2.x的框架，又一个貌似很火的概念出来了S2SH （Struts2+Spring+Hibernate ）整合开发。</p>
<p>不要再被蒙蔽了，看看下面的调查统计吧</p>
<img src="/2020/04/18/SpringMVC/SpringMVC/image-20200418195028056.png" alt="image-20200418195028056" style="zoom:80%;">

<p>SpringMVC的市场占有率是40% ，而Struts2只有可怜的6%。这已然说明了学习SpringMVC的必要性了，再说了，SpringMVC本身就是spring家族的一员，与整合spring时，SpringMVC根本无需中间整合包，而struts2得需要。</p>
<h3 id="六大组件介绍"><a href="#六大组件介绍" class="headerlink" title="六大组件介绍"></a>六大组件介绍</h3><p><img src="/2020/04/18/SpringMVC/SpringMVC/image-20200418195124015.png" alt="image-20200418195124015"></p>
<h4 id="六大组件-MVC组件其他三大组件-说明"><a href="#六大组件-MVC组件其他三大组件-说明" class="headerlink" title="六大组件(MVC组件其他三大组件)说明"></a>六大组件(MVC组件其他三大组件)说明</h4><p>说明：</p>
<ol>
<li>在springmvc 的各个组件中，前端控制器、处理器、视图 称为springmvc 的MVC组件</li>
<li>在springmvc 的各个组件中，处理器映射器、处理器适配器、视图解析器 称为springmvc 的三大组件</li>
<li>需要开发的组件有：处理器、视图</li>
</ol>
<p><strong>DispatcherServlet ：前端控制器</strong></p>
<p>用户请求到达前端控制器，它就相当于mvc模式中的C，dispatcherServlet是整个流程控制的中心，由它调用其它组件处理用户的请求，dispatcherServlet的存在降低了组件之间的耦合性。</p>
<p><strong>Handler ：处理器</strong></p>
<p>Handler 是继DispatcherServlet前端控制器的后端控制器，在DispatcherServlet的控制下Handler对具体的用户请求进行处理。<br>由于Handler涉及到具体的用户业务请求，所以一般情况需要程序员根据业务需求开发Handler。</p>
<p><strong>View ：视图</strong></p>
<p>springmvc框架提供了很多的View视图类型的支持，包括：jstlView、freemarkerView、pdfView等。我们最常用的视图就是jsp。</p>
<p>一般情况下需要通过页面标签或页面模版技术将模型数据通过页面展示给用户，需要由程序员根据业务需求开发<br>具体的页面。</p>
<p><strong>HandlerMapping ：处理器映射器</strong></p>
<p>HandlerMapping负责根据用户请求找到Handler即处理器，springmvc提供了不同的映射器实现不同的映射方式，例如：配置文件方式，实现接口方式，注解方式等。</p>
<p><strong>HandlAdapter ：处理器适配器</strong></p>
<p>通过HandlerAdapter对处理器进行执行，这是适配器模式的应用，通过扩展适配器可以对更多类型的处理器进<br>行执行。</p>
<p><strong>View Resolver ：视图解析器</strong></p>
<p>View Resolver负责将处理结果生成View视图，View Resolver首先根据逻辑视图名解析成物理视图名即具体的页面地址，再生成View视图对象，最后对View进行渲染将处理结果通过页面展示给用户。</p>
<h2 id="项目搭建篇"><a href="#项目搭建篇" class="headerlink" title="项目搭建篇"></a>项目搭建篇</h2><h3 id="搭建入门工程"><a href="#搭建入门工程" class="headerlink" title="搭建入门工程"></a>搭建入门工程</h3><p>添加依赖</p>
<p>就是mvc 依赖、jstl 依赖还有servlet-api 依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0</span></span></span><br><span class="line"><span class="tag"><span class="string">                             http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.kkb<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springmvc-demo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>war<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- spring MVC依赖包--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.0.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- jstl --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jstl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- servlet --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 配置Maven的JDK编译级别--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">encoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.maven<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat7-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">path</span>&gt;</span>/<span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">port</span>&gt;</span>8080<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>开发步骤</p>
<p>配置部分</p>
<p>web.xml</p>
<p>在web.xml 中添加前端控制器DispatcherServlet 的配置。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns</span>=<span class="string">"http://java.sun.com/xml/ns/javaee"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://java.sun.com/xml/ns/javaee</span></span></span><br><span class="line"><span class="tag"><span class="string">                             http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">"2.5"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 学习前置条件--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 问题1：web.xml中servelet、filter、listener、context-param加载顺序--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 问题2：load-on-startup标签的作用，影响了servlet对象创建的时机--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 问题3：url-pattern标签的配置方式有四种：/dispatcherServlet、/servlet/* 、* 、/</span></span><br><span class="line"><span class="comment">,以上四种配置，优先级是如何的--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 问题4：url-pattern标签的配置为/*报错，原因是它拦截了JSP请求，但是又不能处理JSP请求。为什</span></span><br><span class="line"><span class="comment">么配置/就不拦截JSP请求，而配置/*，就会拦截JSP请求--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 问题5：配置了springmvc去读取spring配置文件之后，就产生了spring父子容器的问题--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置前端控制器--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>springmvc<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servletclass</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 设置spring配置文件路径--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 如果不设置初始化参数，那么DispatcherServlet会读取默认路径下的配置文件--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 默认配置文件路径：/WEB-INF/springmvc-servlet.xml --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:springmvc.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 指定初始化时机，设置为2，表示Tomcat启动时，DispatcherServlet会跟随着初始化--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 如果不指定初始化时机，DispatcherServlet就会在第一次被请求的时候，才会初始化，而且只</span></span><br><span class="line"><span class="comment">会被初始化一次--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>2<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>springmvc<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- URL-PATTERN的设置--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 不要配置为/*,否则报错--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 通俗解释：/*，会拦截整个项目中的资源访问，包含JSP和静态资源的访问，对于静态资源的访问</span></span><br><span class="line"><span class="comment">springMVC提供了默认的Handler处理器--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 但是对于JSP来讲，springmvc没有提供默认的处理器，我们也没有手动编写对于的处理器，此时</span></span><br><span class="line"><span class="comment">按照springmvc的处理流程分析得知，它短路了--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- &lt;servlet&gt; --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- &lt;servlet-name&gt;sss&lt;/servlet-name&gt; --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- &lt;servlet-class&gt;sss&lt;/servlet-class&gt; --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- &lt;/servlet&gt; --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- &lt;servlet-mapping&gt; --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- &lt;servlet-name&gt;sss&lt;/servlet-name&gt; --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- &lt;url-pattern&gt;/sss&lt;/url-pattern&gt; --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- &lt;/servlet-mapping&gt; --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>springmvc.xml</p>
<p>DispatcherServlet 启动时会去加载springmvc.xml 文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmlns:mvc</span>=<span class="string">"http://www.springframework.org/schema/mvc"</span></span></span><br><span class="line"><span class="tag"><span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/context/spring-context.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/mvc</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/mvc/spring-mvc.xsd"</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- 配置处理器Bean的读取--&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 扫描controller注解,多个包中间使用半角逗号分隔--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"com.kkb.springmvc.controller"</span>/&gt;</span></span><br><span class="line">   </span><br><span class="line">   <span class="comment">&lt;!-- 配置三大组件之处理器适配器和处理器映射器--&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- 内置了RequestMappingHandlerMapping和RequestMappingHandlerAdapter等组件注册--&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">mvc:annotation-driven</span> /&gt;</span>  </span><br><span class="line">   </span><br><span class="line">   <span class="comment">&lt;!-- 配置三大组件之视图解析器--&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- InternalResourceViewResolver:默认支持JSP视图解析--&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.view.InternalResourceViewResolver"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"prefix"</span> <span class="attr">value</span>=<span class="string">"/WEB-INF/jsp/"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"suffix"</span> <span class="attr">value</span>=<span class="string">".jsp"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>配置说明</p>
<p>mvc:annotation-drivern</p>
<ul>
<li>ContentNegotiationManagerFactoryBean</li>
<li>RequestMappingHandlerMapping(重要)</li>
<li>ConfigurableWebBindingInitializer</li>
<li>RequestMappingHandlerAdapter(重要)</li>
<li>CompositeUriComponentsContributorFactoryBean</li>
<li>ConversionServiceExposingInterceptor</li>
<li>MappedInterceptor</li>
<li>ExceptionHandlerExceptionResolver</li>
<li>ResponseStatusExceptionResolver</li>
<li>DefaultHandlerExceptionResolver</li>
<li>BeanNameUrlHandlerMapping</li>
<li>HttpRequestHandlerAdapter</li>
<li>SimpleControllerHandlerAdapter</li>
<li>HandlerMappingIntrospector</li>
</ul>
<p>编码部分</p>
<p>Controller</p>
<p>处理器开发方式有多种：</p>
<ul>
<li>实现HttpRequestHandler接口</li>
<li>实现Controller接口</li>
<li>使用注解方式</li>
</ul>
<p>不过企业开发中，推荐使用注解方式 开发处理器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//@Controller：在类上添加该注解，指定该类为一个请求处理器，不需要实现任何接口或者继承任何类。</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line">   <span class="comment">//@RequestMapping：在方法上或者类上添加该注解，指定请求的`url`由该方法处理。</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"showView"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">showView</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">"hello"</span>;</span><br><span class="line">&#125;</span><br><span class="line">   <span class="meta">@RequestMapping</span>(<span class="string">"showData"</span>)</span><br><span class="line">   <span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">showData</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">"showData"</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意事项</p>
<p>@Controller 注解的类中每个@RequestMapping 注解的方法，最终都会转为HandlerMethod 类（而这个类才是SpringMVC 注解开发方式中真正意义的处理器）</p>
<p>访问测试</p>
<p>访问地址：<a href="http://localhost:8080/showView\" target="_blank" rel="noopener">http://localhost:8080/showView\</a></p>
<h3 id="SSM框架整合"><a href="#SSM框架整合" class="headerlink" title="SSM框架整合"></a>SSM框架整合</h3><h4 id="整合思路"><a href="#整合思路" class="headerlink" title="整合思路"></a>整合思路</h4><p>将工程的三层结构中的JavaBean 分别使用Spring容器（通过XML方式 ）进行管理。</p>
<ol>
<li>整合持久层mapper ，包括数据源、SqlSessionFactory 及mapper 代理对象的整合；</li>
<li>整合业务层Service ，包括事务Bean 及service 的bean 的配置；</li>
<li>整合表现层Controller ，直接使用springmvc 的配置。</li>
<li>Web.xml 加载spring 容器（包含多个XML文件，还分为父子容器）</li>
</ol>
<p>核心配置文件</p>
<ul>
<li><p>applicationContext-dao.xml</p>
</li>
<li><p>applicationContext-service.xml</p>
</li>
<li><p>springmvc.xml</p>
</li>
<li><p>web.xml</p>
</li>
</ul>
<p>工程搭建</p>
<p>依赖包</p>
<ul>
<li>spring（包括springmvc）</li>
<li>mybatis</li>
<li>mybatis-spring整合包</li>
<li>数据库驱动</li>
<li>第三方连接池</li>
<li>JSTL</li>
<li>servlet-api</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0</span></span></span><br><span class="line"><span class="tag"><span class="string">                             http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.kkb<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ssm-5<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>war<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 持久层依赖开始--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- spring ioc组件需要的依赖包--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-beans<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.0.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.0.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.0.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-expression<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.0.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- spring 事务管理和JDBC依赖包--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-tx<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.0.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.0.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- mysql数据库驱动包--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.35<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- dbcp连接池的依赖包--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-dbcp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-dbcp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- mybatis依赖--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- mybatis和spring的整合依赖--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 持久层依赖结束--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 业务层依赖开始--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 基于AspectJ的aop依赖--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-aspects<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.0.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>aopalliance<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aopalliance<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 业务层依赖结束--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 表现层依赖开始--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- spring MVC依赖包--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.0.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.0.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- jstl 取决于视图对象是否是JSP --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jstl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context-support<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.0.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-oxm<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.0.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.thoughtworks.xstream<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xstream<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 表现层依赖结束--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- spring 单元测试组件包--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.0.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 单元测试Junit --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- Mock测试使用的json-path依赖--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.jayway.jsonpath<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>json-path<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 文件上传--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-fileupload<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-fileupload<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 配置Maven的JDK编译级别--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">encoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.maven<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat7-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">path</span>&gt;</span>/<span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">port</span>&gt;</span>80<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="工程整合（配置文件）"><a href="#工程整合（配置文件）" class="headerlink" title="工程整合（配置文件）"></a>工程整合（配置文件）</h4><p>整合Mapper</p>
<p>applicationContext-dao.xml（核心）</p>
<p>在classpath 下，创建spring 目录，然后创建SqlMapConfig.xml </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag"><span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="tag"><span class="string">http://www.springframework.org/schema/context/spring-context.xsd"</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 加载db.properties --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">"classpath:db.properties"</span> /&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 配置数据源--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"org.apache.commons.dbcp.BasicDataSource"</span></span></span><br><span class="line"><span class="tag"><span class="attr">destroy-method</span>=<span class="string">"close"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClassName"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.driver&#125;"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.url&#125;"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.username&#125;"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.password&#125;"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxActive"</span> <span class="attr">value</span>=<span class="string">"30"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxIdle"</span> <span class="attr">value</span>=<span class="string">"5"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 配置SqlSessionFacotory --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"sqlSessionFactory"</span> <span class="attr">class</span>=<span class="string">"org.mybatis.spring.SqlSessionFactoryBean"</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 配置数据源--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span> /&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"typeAliasesPackage"</span> <span class="attr">value</span>=<span class="string">"com.kkb.ssm.po"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 配置mapper扫描器，SqlSessionConfig.xml中的mapper配置去掉--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.mybatis.spring.mapper.MapperScannerConfigurer"</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 指定扫描的包--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"basePackage"</span> <span class="attr">value</span>=<span class="string">"com.kkb.ssm.mapper"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>db.properties</p>
<p>在classpath 下，创建db.properties </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">jdbc.driver=com.mysql.jdbc.Driver  </span><br><span class="line">jdbc.url=jdbc:mysql://localhost:3306/ssm?characterEncoding=utf8  </span><br><span class="line">jdbc.username=root  </span><br><span class="line">jdbc.password=root</span><br></pre></td></tr></table></figure>

<p>log4j.properties</p>
<p>在classpath 下，创建log4j.properties </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#dev env [debug] product   env [info]  </span><br><span class="line">log4j.rootLogger=DEBUG,   stdout  </span><br><span class="line"># Console output...  </span><br><span class="line">log4j.appender.stdout=org.apache.log4j.ConsoleAppender</span><br><span class="line">log4j.appender.stdout.layout=org.apache.log4j.PatternLayout</span><br><span class="line">log4j.appender.stdout.layout.ConversionPattern=%5p   [%t] - %m%n</span><br></pre></td></tr></table></figure>

<p>整合Service</p>
<p>applicationContext-service.xml</p>
<p>在spring 文件夹下创建applicationContext-service.xml ，文件中配置service 。在这个配置文件中，需要配置service 的bean 和事务管理。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span>                </span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:tx</span>=<span class="string">"http://www.springframework.org/schema/tx"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/context/spring-context.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/aop</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/aop/spring-aop.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/tx</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/tx/spring-tx.xsd"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 扫描Service --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"com.kkb.ssm.service"</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置事务--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 事务管理器，对mybatis操作数据库进行事务控制，此处使用jdbc的事务控制--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"transactionManager"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 指定要进行事务管理的数据源--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 通知--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tx:advice</span> <span class="attr">id</span>=<span class="string">"txAdvice"</span> <span class="attr">transaction-manager</span>=<span class="string">"transactionManager"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 传播行为--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"save*"</span> <span class="attr">propagation</span>=<span class="string">"REQUIRED"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"add*"</span> <span class="attr">propagation</span>=<span class="string">"REQUIRED"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"insert*"</span> <span class="attr">propagation</span>=<span class="string">"REQUIRED"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"delete*"</span> <span class="attr">propagation</span>=<span class="string">"REQUIRED"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"del*"</span> <span class="attr">propagation</span>=<span class="string">"REQUIRED"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"remove*"</span> <span class="attr">propagation</span>=<span class="string">"REQUIRED"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"update*"</span> <span class="attr">propagation</span>=<span class="string">"REQUIRED"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"modify*"</span> <span class="attr">propagation</span>=<span class="string">"REQUIRED"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"find*"</span> <span class="attr">read-only</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"query*"</span> <span class="attr">read-only</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"select*"</span> <span class="attr">read-only</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"get*"</span> <span class="attr">read-only</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tx:advice</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- aop --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:advisor</span> <span class="attr">advice-ref</span>=<span class="string">"txAdvice"</span></span></span><br><span class="line"><span class="tag">                     <span class="attr">pointcut</span>=<span class="string">"execution(* com.kkb.ssm.service.impl.*.*(..))"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>整合Controller</p>
<p>Spring 和springmvc 之间无需整合，直接用springmvc的配置</p>
<p>web.xml</p>
<p>在web.xml 中添加springmvc 的配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns</span>=<span class="string">"http://java.sun.com/xml/ns/javaee"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:web</span>=<span class="string">"http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://java.sun.com/xml/ns/javaee</span></span></span><br><span class="line"><span class="tag"><span class="string">                             http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">id</span>=<span class="string">"WebApp_ID"</span> <span class="attr">version</span>=<span class="string">"2.5"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置springmvc的前端控制器--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>springmvc<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servletclass</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:spring/springmvc.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>springmvc<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>springmvc.xml</p>
<p>在spring 包下创建springmvc.xml 文件，内容如下</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:mvc</span>=<span class="string">"http://www.springframework.org/schema/mvc"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/mvc</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/mvc/spring-mvc.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/context/spring-context.xsd"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置处理器映射器和处理器适配器--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:annotation-driven</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置视图解析器--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.view.InternalResourceViewResolver"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"prefix"</span> <span class="attr">value</span>=<span class="string">"/WEB-INF/jsp/"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"suffix"</span> <span class="attr">value</span>=<span class="string">".jsp"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 使用注解的handler可以使用组件扫描器，加载handler --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"com.kkb.ssm.controller"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>web.xml加载spring父容器</p>
<p>在web.xml中，使用监听器来对spring的配置文件进行加载</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 加载spring容器--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">context-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span></span><br><span class="line">        classpath:spring/applicationContext-*.xml</span><br><span class="line">    <span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="tag">&lt;/<span class="name">listenerclass</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="整合测试（编写代码）"><a href="#整合测试（编写代码）" class="headerlink" title="整合测试（编写代码）"></a>整合测试（编写代码）</h4><p>需求</p>
<p>实现商品查询列表，从mysql 数据库查询商品信息</p>
<p>需求分析</p>
<p>表现层<br>请求URL：/queryItem<br>请求参数：无<br>请求返回值：json格式数据<br>业务层<br>业务处理逻辑（需求分析）：实现商品列表的查询<br>持久层<br>只针对表进行增删改查操作</p>
<p>持久层代码</p>
<p>根据需求分析，持久层需要查询item表中的记录，使用逆向工程的代码即可。</p>
<p>通过逆向工程，把po类、mapper.xml和mapper.java类生成出来并拷贝到项目中。</p>
<p>业务层代码</p>
<p>根据需求开发service的接口以及实现类，注意：使用注解 @Service开发service 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ItemServiceImpl</span> <span class="keyword">implements</span> <span class="title">ItemService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ItemMapper mapper;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Item&gt; <span class="title">queryItemList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ItemExample example = <span class="keyword">new</span> ItemExample();</span><br><span class="line">        <span class="keyword">return</span> mapper.selectByExample(example);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>表现层代码</p>
<p>在Controller 类上添加@Controller注解</p>
<p>在Controller 方法上添加@RequestMapping 注解进行url请求映射</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ItemController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ItemService service;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/item"</span>)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Item&gt; <span class="title">queryItem</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 根据查询条件去数据库中查询商品列表</span></span><br><span class="line">        List&lt;Item&gt; itemList = service.queryItemList();</span><br><span class="line">        <span class="keyword">return</span> itemList;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>部署测试</p>
<p><a href="http://localhost:8080/ssm/item" target="_blank" rel="noopener">http://localhost:8080/ssm/item</a></p>
<h2 id="应用掌握篇"><a href="#应用掌握篇" class="headerlink" title="应用掌握篇"></a>应用掌握篇</h2><h3 id="返回值处理"><a href="#返回值处理" class="headerlink" title="返回值处理"></a>返回值处理</h3><h4 id="不使用注解修饰"><a href="#不使用注解修饰" class="headerlink" title="不使用注解修饰"></a>不使用注解修饰</h4><h5 id="ModelAndView"><a href="#ModelAndView" class="headerlink" title="ModelAndView"></a>ModelAndView</h5><p>Controller方法中定义ModelAndView对象并返回，对象中可添加model数据、指定view。</p>
<h5 id="void"><a href="#void" class="headerlink" title="void"></a>void</h5><p>在Controller 方法形参上可以定义request和response ，使用request 或response 指定响应结果</p>
<p>void service(HttpServletRequest request,HttpServletResponse response){}</p>
<p>使用request转发向页面，如下：</p>
<h5 id="String（推荐）"><a href="#String（推荐）" class="headerlink" title="String（推荐）"></a>String（推荐）</h5><p>逻辑视图名</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Kafka/Kafka" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2020/04/18/Kafka/Kafka/" class="article-date">
      <time datetime="2020-04-18T07:09:15.562Z" itemprop="datePublished">2020-04-18</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="分布式消息系统Kafka"><a href="#分布式消息系统Kafka" class="headerlink" title="分布式消息系统Kafka"></a>分布式消息系统Kafka</h1><h2 id="第1章Kafka概述"><a href="#第1章Kafka概述" class="headerlink" title="第1章Kafka概述"></a>第1章Kafka概述</h2><h3 id="kafaka-简介"><a href="#kafaka-简介" class="headerlink" title="kafaka 简介"></a>kafaka 简介</h3><p>Apache Kafka 是一个快速、可扩展的、高吞吐的、可容错的分布式“发布-订阅”消息系统，使用Scala 与Java 语言编写，能够将消息从一个端点传递到另一个端点，较之传统的消息中间件（例如ActiveMQ、RabbitMQ），Kafka 具有高吞吐量、内置分区、支持消息副本和高容错的特性，非常适合大规模消息处理应用程序。</p>
<p>Kafka 官网：<a href="http://kafka.apache.org/" target="_blank" rel="noopener">http://kafka.apache.org/</a></p>
<h3 id="Kafa-系统架构"><a href="#Kafa-系统架构" class="headerlink" title="Kafa 系统架构"></a>Kafa 系统架构</h3><p><img src="/2020/04/18/Kafka/Kafka/image-20200418150830785.png" alt="image-20200418150830785"></p>
<h3 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h3><p>Kafka 的应用场景很多，这里就举几个最常见的场景。</p>
<h4 id="用户的活动追踪"><a href="#用户的活动追踪" class="headerlink" title="用户的活动追踪"></a>用户的活动追踪</h4><p>用户在网站的不同活动消息发布到不同的主题中心，然后可以对这些消息进行实时监测实时处理。当然，也可加载到Hadoop 或离线处理数据仓库，对用户进行画像。像淘宝、京东这些大型的电商平台，用户的所有活动都是要进行追踪的。</p>
<h4 id="日志聚合"><a href="#日志聚合" class="headerlink" title="日志聚合"></a>日志聚合</h4><p><img src="/2020/04/18/Kafka/Kafka/image-20200418151054236.png" alt="image-20200418151054236"></p>
<h4 id="限流削峰"><a href="#限流削峰" class="headerlink" title="限流削峰"></a>限流削峰</h4><p><img src="/2020/04/18/Kafka/Kafka/image-20200418151120619.png" alt="image-20200418151120619"></p>
<h3 id="kafka-高吞吐率实现"><a href="#kafka-高吞吐率实现" class="headerlink" title="kafka 高吞吐率实现"></a>kafka 高吞吐率实现</h3><p>Kafka 与其它MQ 相比，其最大的特点就是高吞吐率。为了增加存储能力，Kafka 将所有的消息都写入到了低速大容的硬盘。按理说，这将导致性能损失，但实际上，kafka 仍可保持超高的吞吐率，性能并未受到影响。其主要采用了如下的方式实现了高吞吐率。</p>
<ul>
<li>顺序读写：Kafka 将消息写入到了分区partition 中，而分区中消息是顺序读写的。顺序读写要远快于随机读写。</li>
<li>零拷贝：生产者、消费者对于kafka 中消息的操作是采用零拷贝实现的。</li>
<li>批量发送：Kafka 允许使用批量消息发送模式。</li>
<li>消息压缩：Kafka 支持对消息集合进行压缩。</li>
</ul>
<h2 id="第2章Kafka工作原理与工作过程"><a href="#第2章Kafka工作原理与工作过程" class="headerlink" title="第2章Kafka工作原理与工作过程"></a>第2章Kafka工作原理与工作过程</h2><h3 id="Kafka-基本原理"><a href="#Kafka-基本原理" class="headerlink" title="Kafka 基本原理"></a>Kafka 基本原理</h3><h3 id="Kafka-工作原理与过程"><a href="#Kafka-工作原理与过程" class="headerlink" title="Kafka 工作原理与过程"></a>Kafka 工作原理与过程</h3><h3 id="Kafka-集群搭建"><a href="#Kafka-集群搭建" class="headerlink" title="Kafka 集群搭建"></a>Kafka 集群搭建</h3><p>在生产环境中为了防止单点问题，Kafka 都是以集群方式出现的。下面要搭建一个Kafka<br>集群，包含三个Kafka 主机，即三个Broker。</p>
<h4 id="Kafka的下载"><a href="#Kafka的下载" class="headerlink" title="Kafka的下载"></a>Kafka的下载</h4><p><img src="/2020/04/18/Kafka/Kafka/image-20200418151311727.png" alt="image-20200418151311727"></p>
<h4 id="安装并配置第一台主机"><a href="#安装并配置第一台主机" class="headerlink" title="安装并配置第一台主机"></a>安装并配置第一台主机</h4><p><strong>上传并解压</strong></p>
<p>将下载好的Kafka 压缩包上传至CentOS 虚拟机，并解压。</p>
<p><img src="/2020/04/18/Kafka/Kafka/image-20200418151358365.png" alt="image-20200418151358365"></p>
<p><strong>创建软链接</strong></p>
<p><img src="/2020/04/18/Kafka/Kafka/image-20200418151414166.png" alt="image-20200418151414166"></p>
<p><strong>修改配置文件</strong></p>
<p>在kafka 安装目录下有一个config/server.properties 文件，修改该文件。</p>
<p><img src="/2020/04/18/Kafka/Kafka/image-20200418151434608.png" alt="image-20200418151434608"></p>
<p><img src="/2020/04/18/Kafka/Kafka/image-20200418151441434.png" alt="image-20200418151441434"></p>
<p><img src="/2020/04/18/Kafka/Kafka/image-20200418151447611.png" alt="image-20200418151447611"></p>
<h4 id="再克隆两台Kafka"><a href="#再克隆两台Kafka" class="headerlink" title="再克隆两台Kafka"></a>再克隆两台Kafka</h4><p>以kafkaOS1 为母机再克隆两台Kafka 主机。在克隆完毕后，需要修改server.properties中的broker.id、listeners 与advertised.listeners。</p>
<p><img src="/2020/04/18/Kafka/Kafka/image-20200418151515232.png" alt="image-20200418151515232"></p>
<p><img src="/2020/04/18/Kafka/Kafka/image-20200418151522584.png" alt="image-20200418151522584"></p>
<h4 id="kafka的启动与停止"><a href="#kafka的启动与停止" class="headerlink" title="kafka的启动与停止"></a>kafka的启动与停止</h4><p><strong>启动zookeeper</strong></p>
<p><img src="/2020/04/18/Kafka/Kafka/image-20200418151546794.png" alt="image-20200418151546794"></p>
<p><strong>启动kafka</strong></p>
<p>在命令后添加-daemon 参数，可以使kafka 以守护进程方式启动，即不占用窗口。</p>
<p><img src="/2020/04/18/Kafka/Kafka/image-20200418151603611.png" alt="image-20200418151603611"></p>
<p><strong>停止kafka</strong></p>
<p><img src="/2020/04/18/Kafka/Kafka/image-20200418151615853.png" alt="image-20200418151615853"></p>
<h4 id="kafka操作"><a href="#kafka操作" class="headerlink" title="kafka操作"></a>kafka操作</h4><p><strong>创建topic</strong></p>
<p><img src="/2020/04/18/Kafka/Kafka/image-20200418151637049.png" alt="image-20200418151637049"></p>
<p><strong>查看topic</strong></p>
<p><img src="/2020/04/18/Kafka/Kafka/image-20200418152242515.png" alt="image-20200418152242515"></p>
<p><strong>发送消息</strong></p>
<p>该命令会创建一个生产者，然后由其生产消息。</p>
<p><img src="/2020/04/18/Kafka/Kafka/image-20200418152258625.png" alt="image-20200418152258625"></p>
<p><strong>消费消息</strong></p>
<p><img src="/2020/04/18/Kafka/Kafka/image-20200418152308952.png" alt="image-20200418152308952"></p>
<p><strong>继续生产消费</strong></p>
<p><img src="/2020/04/18/Kafka/Kafka/image-20200418152320714.png" alt="image-20200418152320714"></p>
<p><img src="/2020/04/18/Kafka/Kafka/image-20200418152328445.png" alt="image-20200418152328445"></p>
<p><strong>删除topic</strong></p>
<p><img src="/2020/04/18/Kafka/Kafka/image-20200418152345425.png" alt="image-20200418152345425"></p>
<h3 id="日志查看"><a href="#日志查看" class="headerlink" title="日志查看"></a>日志查看</h3><p>我们这里说的日志不是Kafka 的启动日志，启动日志在Kafka 安装目录下的logs/server.log中。消息在磁盘上都是以日志的形式保存的。我们这里说的日志是存放在/tmp/kafka_logs目录中的消息日志，即partition 与segment。</p>
<h4 id="查看分区与备份"><a href="#查看分区与备份" class="headerlink" title="查看分区与备份"></a>查看分区与备份</h4><p><strong>1 个分区1 个备份</strong></p>
<p>我们前面创建的test 主题是1 个分区1 个备份。</p>
<p><img src="/2020/04/18/Kafka/Kafka/image-20200418152504351.png" alt="image-20200418152504351"></p>
<p><strong>3 个分区1 个备份</strong></p>
<p>再次创建一个主题，命名为one，创建三个分区，但仍为一个备份。依次查看三台broker，可以看到每台broker 中都有一个one 主题的分区。</p>
<p><img src="/2020/04/18/Kafka/Kafka/image-20200418152523123.png" alt="image-20200418152523123"></p>
<p><strong>3 个分区3 个备份</strong></p>
<p>再次创建一个主题，命名为two，创建三个分区，三个备份。依次查看三台broker，可以看到每台broker 中都有三份two 主题的分区。</p>
<p><img src="/2020/04/18/Kafka/Kafka/image-20200418152542890.png" alt="image-20200418152542890"></p>
<h4 id="查看段segment"><a href="#查看段segment" class="headerlink" title="查看段segment"></a>查看段segment</h4><p><strong>segment 文件</strong></p>
<p>segment 是一个逻辑概念，其由两类物理文件组成，分别为“.index”文件和“.log”文件。“.log”文件中存放的是消息，而“.index”文件中存放的是“.log”文件中消息的索引。</p>
<p>00000000000000001456.log</p>
<p><img src="/2020/04/18/Kafka/Kafka/image-20200418152627694.png" alt="image-20200418152627694"></p>
<p><strong>查看segment</strong></p>
<p>对于segment 中的log 文件，不能直接通过cat 命令查找其内容，而是需要通过kafka自带的一个工具查看。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-run-class.sh kafka.tools.DumpLogSegments --files /tmp/kafka-logs/test-0/00000000000000000000.log --print-data-log</span><br></pre></td></tr></table></figure>

<p>一个用户的一个主题会被提交到一个__consumer_offsets 分区中。使用主题字符串的hash 值与50 取模，结果即为分区索引。</p>
<h2 id="第3章Kafka-API"><a href="#第3章Kafka-API" class="headerlink" title="第3章Kafka API"></a>第3章Kafka API</h2><p>首先在命令行创建一个名称为cities 的主题，并创建该主题的订阅者。</p>
<h3 id="使用kafka-原生API"><a href="#使用kafka-原生API" class="headerlink" title="使用kafka 原生API"></a>使用kafka 原生API</h3><h4 id="创建工程"><a href="#创建工程" class="headerlink" title="创建工程"></a>创建工程</h4><p>创建一个Maven 的Java 工程，命名为kafkaDemo。创建时无需导入依赖。为了简单，后面的发布者与消费者均创建在该工程中。</p>
<p><img src="/2020/04/18/Kafka/Kafka/image-20200418153357980.png" alt="image-20200418153357980"></p>
<h4 id="导入依赖"><a href="#导入依赖" class="headerlink" title="导入依赖"></a>导入依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- kafka依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.kafka<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kafka_2.12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="创建发布者OneProducer"><a href="#创建发布者OneProducer" class="headerlink" title="创建发布者OneProducer"></a>创建发布者OneProducer</h4><p><strong>创建发布者类OneProducer</strong></p>
<p><img src="/2020/04/18/Kafka/Kafka/image-20200418153456885.png" alt="image-20200418153456885"></p>
<p><img src="/2020/04/18/Kafka/Kafka/image-20200418153505207.png" alt="image-20200418153505207"></p>
<p><strong>创建测试类OneProducerTest</strong></p>
<p><img src="/2020/04/18/Kafka/Kafka/image-20200418153522689.png" alt="image-20200418153522689"></p>
<h4 id="创建发布者TwoProducer"><a href="#创建发布者TwoProducer" class="headerlink" title="创建发布者TwoProducer"></a>创建发布者TwoProducer</h4><p>前面的方式在消息发送成功后，代码中没有任何提示，这里可以使用回调方式，即发送成功后，会触发回调方法的执行。</p>
<p><strong>创建发布者类TwoProducer</strong></p>
<p>复制OneProducer 类，仅修改sendMsg()方法。</p>
<p><img src="/2020/04/18/Kafka/Kafka/image-20200418153557976.png" alt="image-20200418153557976"></p>
<p><strong>创建测试类TwoProducerTest</strong></p>
<p><img src="/2020/04/18/Kafka/Kafka/image-20200418153611185.png" alt="image-20200418153611185"></p>
<h4 id="批量发送消息"><a href="#批量发送消息" class="headerlink" title="批量发送消息"></a>批量发送消息</h4><p><strong>创建发布者类SomeProducerBatch</strong></p>
<p>复制前面的发布者类，在其基础上进行修改。</p>
<p><img src="/2020/04/18/Kafka/Kafka/image-20200418153637689.png" alt="image-20200418153637689"></p>
<p><img src="/2020/04/18/Kafka/Kafka/image-20200418153653616.png" alt="image-20200418153653616"></p>
<p><strong>创建测试类ProducerBatchTes</strong></p>
<p><img src="/2020/04/18/Kafka/Kafka/image-20200418153708533.png" alt="image-20200418153708533"></p>
<h4 id="消费者组"><a href="#消费者组" class="headerlink" title="消费者组"></a>消费者组</h4><p><strong>创建消费者类SomeConsumer</strong></p>
<p><img src="/2020/04/18/Kafka/Kafka/image-20200418153726603.png" alt="image-20200418153726603"></p>
<p><img src="/2020/04/18/Kafka/Kafka/image-20200418153734746.png" alt="image-20200418153734746"></p>
<p><strong>创建测试类ConsumerTest</strong></p>
<p><img src="/2020/04/18/Kafka/Kafka/image-20200418153753774.png" alt="image-20200418153753774"></p>
<h4 id="消费者同步手动提交"><a href="#消费者同步手动提交" class="headerlink" title="消费者同步手动提交"></a>消费者同步手动提交</h4><p><strong>自动提交的问题</strong></p>
<p>前面的消费者都是以自动提交offset 的方式对broker 中的消息进行消费的，但自动提交可能会出现消息重复消费的情况。所以在生产环境下，很多时候需要对offset 进行手动提交，以解决重复消费的问题。</p>
<p><strong>手动提交分类</strong></p>
<p>手动提交又可以划分为同步提交、异步提交，同异步联合提交。这些提交方式仅仅是doWork()方法不相同，其构造器是相同的。所以下面首先在前面消费者类的基础上进行构造器的修改，然后再分别实现三种不同的提交方式。</p>
<p><strong>创建消费者类SyncManualConsumer</strong></p>
<p>原理</p>
<p>同步提交方式是，消费者向broker 提交offset 后等待broker 成功响应。若没有收到响应，则会重新提交，直到获取到响应。而在这个等待过程中，消费者是阻塞的。其严重影响了消费者的吞吐量。</p>
<p>修改构造器</p>
<p>直接复制前面的SomeConsumer，在其基础上进行修改。</p>
<p><img src="/2020/04/18/Kafka/Kafka/image-20200418153932380.png" alt="image-20200418153932380"></p>
<p>修改doWork()方法</p>
<p><img src="/2020/04/18/Kafka/Kafka/image-20200418153942897.png" alt="image-20200418153942897"></p>
<p><strong>创建测试类SyncManulTest</strong></p>
<p><img src="/2020/04/18/Kafka/Kafka/image-20200418153959049.png" alt="image-20200418153959049"></p>
<h4 id="消费者异步手动提交"><a href="#消费者异步手动提交" class="headerlink" title="消费者异步手动提交"></a>消费者异步手动提交</h4><p><strong>原理</strong></p>
<p>手动同步提交方式需要等待broker 的成功响应，效率太低，影响消费者的吞吐量。异步提交方式是，消费者向broker 提交offset 后不用等待成功响应，所以其增加了消费者的吞吐量。</p>
<p><strong>创建消费者类AsyncManualConsumer</strong></p>
<p>复制前面的SyncManualConsumer 类，在其基础上进行修改。</p>
<p><img src="/2020/04/18/Kafka/Kafka/image-20200418154045926.png" alt="image-20200418154045926"></p>
<p><strong>创建测试类AsyncManulTest</strong></p>
<p><img src="/2020/04/18/Kafka/Kafka/image-20200418154101849.png" alt="image-20200418154101849"></p>
<h4 id="消费者同异步手动提交"><a href="#消费者同异步手动提交" class="headerlink" title="消费者同异步手动提交"></a>消费者同异步手动提交</h4><p><strong>原理</strong></p>
<p>同异步提交，即同步提交与异步提交组合使用。一般情况下，若偶尔出现提交失败，其也不会影响消费者的消费。因为后续提交最终会将这次提交失败的offset 给提交了。</p>
<p>但异步提交会产生重复消费，为了防止重复消费，可以将同步提交与异常提交联合使用。</p>
<p><strong>创建消费者类SyncAsyncManualConsumer</strong></p>
<p>复制前面的AsyncManualConsumer 类，在其基础上进行修改。</p>
<p><img src="/2020/04/18/Kafka/Kafka/image-20200418154143311.png" alt="image-20200418154143311"></p>
<h3 id="Spring-Boot-Kafka"><a href="#Spring-Boot-Kafka" class="headerlink" title="Spring Boot Kafka"></a>Spring Boot Kafka</h3><p>为了简单，以下代码是将消息发布者与订阅者定义到了一个工程中的。</p>
<h4 id="创建工程-1"><a href="#创建工程-1" class="headerlink" title="创建工程"></a>创建工程</h4><p>创建一个Spring Boot 工程，导入如下依赖。</p>
<p><img src="/2020/04/18/Kafka/Kafka/image-20200418154236404.png" alt="image-20200418154236404"></p>
<h4 id="定义发布者"><a href="#定义发布者" class="headerlink" title="定义发布者"></a>定义发布者</h4><p>Spring 是通过KafkaTemplate 来完成对Kafka 的操作的。</p>
<p><strong>修改配置文件</strong></p>
<p><img src="/2020/04/18/Kafka/Kafka/image-20200418154330765.png" alt="image-20200418154330765"></p>
<p><strong>定义发布者处理器</strong></p>
<p>Spring Kafka 通过KafkaTemplate 完成消息的发布。</p>
<p><img src="/2020/04/18/Kafka/Kafka/image-20200418154350130.png" alt="image-20200418154350130"></p>
<h4 id="定义消费者"><a href="#定义消费者" class="headerlink" title="定义消费者"></a>定义消费者</h4><p>Spring 是通过监听方式实现消费者的。</p>
<p><strong>修改配置文件</strong></p>
<p>在配置文件中添加如下内容。注意，Spring 中要求必须为消费者指定组。</p>
<p><img src="/2020/04/18/Kafka/Kafka/image-20200418154432579.png" alt="image-20200418154432579"></p>
<p><strong>定义消费者</strong></p>
<p>Spring Kafka 是通过KafkaListener 监听方式来完成消息订阅与接收的。当监听到有指定主题的消息时，就会触发@KafkaListener 注解所标注的方法的执行。</p>
<p><img src="/2020/04/18/Kafka/Kafka/image-20200418154504832.png" alt="image-20200418154504832"></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-0编程工具/Idea" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2020/04/14/0编程工具/Idea/" class="article-date">
      <time datetime="2020-04-14T01:12:04.560Z" itemprop="datePublished">2020-04-14</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/14/0编程工具/Idea/">Idea</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
              <h1 id="IDEA"><a href="#IDEA" class="headerlink" title="IDEA"></a>IDEA</h1><h2 id="IDEA中的-iml文件和-idea文件夹作用和意义"><a href="#IDEA中的-iml文件和-idea文件夹作用和意义" class="headerlink" title="IDEA中的.iml文件和.idea文件夹作用和意义"></a>IDEA中的.iml文件和.idea文件夹作用和意义</h2><p><strong>.iml文件</strong></p>
<p>information of module，即idea对module的配置信息</p>
<p>iml是 intellij idea的工程配置文件，里面是当前project的一些配置信息</p>
<p>iml文件是IntelliJ IDEA自动创建的模块文件，用于Java应用开发，存储一些模块开发相关的信息，比如一个Java组件，插件组件，Maven组件等待，还可能会存储一些模块路径信息，依赖信息以及别的一些设置</p>
          
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/编程工具/">编程工具</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Idea/">Idea</a></li></ul>
    </div>

      
        <p class="article-more-link">
          <a href="/2020/04/14/0编程工具/Idea/#more">阅读全文 >></a>
        </p>
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-9Redis/1Redis" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2020/03/31/9Redis/1Redis/" class="article-date">
      <time datetime="2020-03-31T11:32:56.160Z" itemprop="datePublished">2020-03-31</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/31/9Redis/1Redis/">Redis1</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
              <h1 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h1><h2 id="Redis介绍"><a href="#Redis介绍" class="headerlink" title="Redis介绍"></a>Redis介绍</h2><h3 id="什么是Redis"><a href="#什么是Redis" class="headerlink" title="什么是Redis"></a>什么是Redis</h3><p>Redis是用C语言开发的一个开源的高性能键值对（key-value ）内存数据库 ，它是一种NoSQL<br>数据库</p>
<p>它是【单进程单线程】的内存数据库，所以说不存在线程安全问题</p>
<p>它可以支持并发10WQPS，所以说性能非常优秀。之所以单进程单线程性能还这么好，是因为底层采用了【IO多路复用（NIO思想）】</p>
<p>相比Memcache这种专业缓存技术，Redis有更优秀的读写性能，及丰富的数据类型</p>
<p>它提供了五种数据类型来存储【值】：字符串类型（string）、散列类型（hash）、列表类型（list）、集合类型（set）、有序集合类型（sortedset、zset）</p>
          
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Redis/">Redis</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Redis/">Redis</a></li></ul>
    </div>

      
        <p class="article-more-link">
          <a href="/2020/03/31/9Redis/1Redis/#more">阅读全文 >></a>
        </p>
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-SpringCloud/1SpringCloud" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2020/03/29/SpringCloud/1SpringCloud/" class="article-date">
      <time datetime="2020-03-29T09:23:39.143Z" itemprop="datePublished">2020-03-29</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/29/SpringCloud/1SpringCloud/">Spring Cloud基础</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
              <h1 id="微服务框架Spring-Cloud"><a href="#微服务框架Spring-Cloud" class="headerlink" title="微服务框架Spring Cloud"></a>微服务框架Spring Cloud</h1><h2 id="第1章Spring-Cloud入门"><a href="#第1章Spring-Cloud入门" class="headerlink" title="第1章Spring Cloud入门"></a>第1章Spring Cloud入门</h2><h3 id="Spring-Cloud-简介"><a href="#Spring-Cloud-简介" class="headerlink" title="Spring Cloud 简介"></a>Spring Cloud 简介</h3><p><img src="/2020/03/29/SpringCloud/1SpringCloud/image-20200329173058595.png" alt="image-20200329173058595"></p>
<p>IoT（Internet of Things）物联网，mobile移动端，browser浏览器统称为客户端</p>
<p>API Gateway网关</p>
<p>microservices微服务</p>
<p>breaker dashboard熔断仪表盘</p>
<p>config dashboard 配置仪表盘</p>
<p>service registry 服务注册中心</p>
<p>distributed tracing 分布链跟踪</p>
          
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Spring-Cloud/">Spring Cloud</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring-Cloud/">Spring Cloud</a></li></ul>
    </div>

      
        <p class="article-more-link">
          <a href="/2020/03/29/SpringCloud/1SpringCloud/#more">阅读全文 >></a>
        </p>
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-ZooKeeper/1Zookeeper" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2020/03/29/ZooKeeper/1Zookeeper/" class="article-date">
      <time datetime="2020-03-28T23:36:12.069Z" itemprop="datePublished">2020-03-29</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/29/ZooKeeper/1Zookeeper/">第1章Zookeeper理论基础</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
              <h1 id="分布式协调服务器Zookeeper"><a href="#分布式协调服务器Zookeeper" class="headerlink" title="分布式协调服务器Zookeeper"></a>分布式协调服务器Zookeeper</h1><h2 id="第1章Zookeeper理论基础"><a href="#第1章Zookeeper理论基础" class="headerlink" title="第1章Zookeeper理论基础"></a>第1章Zookeeper理论基础</h2><h3 id="Zookeeper-简介"><a href="#Zookeeper-简介" class="headerlink" title="Zookeeper 简介"></a>Zookeeper 简介</h3><p>ZooKeeper 由雅虎研究院开发，后来捐赠给了Apache。ZooKeeper 是一个开源的分布式应用程序协调服务器，其为分布式系统提供一致性服务。其一致性是通过基于Paxos 算法的ZAB 协议完成的。其主要功能包括：配置维护、域名服务、分布式同步、集群管理等</p>
<p>zookeeper 的官网：<a href="http://zookeeper.apache.org" target="_blank" rel="noopener">http://zookeeper.apache.org</a></p>
<p><img src="/2020/03/29/ZooKeeper/1Zookeeper/image-20200329073617838.png" alt="image-20200329073617838"></p>
          
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Zookeeper基础/">Zookeeper基础</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Zookeeper/">Zookeeper</a></li></ul>
    </div>

      
        <p class="article-more-link">
          <a href="/2020/03/29/ZooKeeper/1Zookeeper/#more">阅读全文 >></a>
        </p>
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-8MySQL/4MySQL" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2020/03/26/8MySQL/4MySQL/" class="article-date">
      <time datetime="2020-03-26T02:02:16.201Z" itemprop="datePublished">2020-03-26</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="事务原理及MVCC"><a href="#事务原理及MVCC" class="headerlink" title="事务原理及MVCC"></a>事务原理及MVCC</h1><h2 id="事务概述"><a href="#事务概述" class="headerlink" title="事务概述"></a>事务概述</h2><p>在MySQL中的事务是由存储引擎实现的，而且支持事务的存储引擎不多，我们主要讲解InnoDB存储引擎中的事务。所以，今天我们就一起来分析和探讨InnoDB的事务机制，希望能建立起对事务底层实现原理的具体了解</p>
<p><img src="/2020/03/26/8MySQL/4MySQL/image-20200326101714003.png" alt="image-20200326101714003"></p>
<p>数据库事务具有ACID四大特性。ACID是以下4个词的缩写：</p>
<ul>
<li>原子性(atomicity) ：事务最小工作单元，要么全成功，要么全失败</li>
<li>一致性(consistency)：事务开始和结束后，数据库的完整性不会被破坏</li>
<li>隔离性(isolation) ：不同事务之间互不影响，四种隔离级别为RU（读未提交）、RC（读已提交）、RR（可重复读）、SERIALIZABLE （串行化）</li>
<li>持久性(durability) ：事务提交后，对数据的修改是永久性的，即使系统故障也不会丢失</li>
</ul>
<h2 id="隔离级别"><a href="#隔离级别" class="headerlink" title="隔离级别"></a>隔离级别</h2><h3 id="事前准备"><a href="#事前准备" class="headerlink" title="事前准备"></a>事前准备</h3><p>我们需要创建一个表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE t (</span><br><span class="line">  id INT PRIMARY KEY,</span><br><span class="line">  c VARCHAR(100)</span><br><span class="line">) Engine=InnoDB CHARSET=utf8;</span><br></pre></td></tr></table></figure>

<p>然后向这个表里插入一条数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO t VALUES(1, &apos;刘备&apos;);</span><br></pre></td></tr></table></figure>

<p>现在表里的数据就是这样的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM t;</span><br><span class="line">+----+--------+</span><br><span class="line">| id | c     |</span><br><span class="line">+----+--------+</span><br><span class="line">|  1 | 刘备  |</span><br><span class="line">+----+--------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure>

<h3 id="未提交读（READ-UNCOMMITTED-RU）"><a href="#未提交读（READ-UNCOMMITTED-RU）" class="headerlink" title="未提交读（READ UNCOMMITTED/RU）"></a>未提交读（READ UNCOMMITTED/RU）</h3><p>脏读：一个事务读取到另一个事务未提交的数据</p>
<p>如果一个事务读到了另一个未提交事务修改过的数据，那么这种隔离级别就称之为未提交读（英文名：READ UNCOMMITTED ），示意图如下：</p>
<p><img src="/2020/03/26/8MySQL/4MySQL/image-20200326102355671.png" alt="image-20200326102355671"></p>
<p>如上图，Session A 和Session B 各开启了一个事务，Session B 中的事务先将id 为1 的记录的列c 更新为’关羽’ ，然后Session A 中的事务再去查询这条id 为1 的记录，那么在未提交读的隔离级别下，查询结果就是’关羽’ ，也就是说某个事务读到了另一个未提交事务修改过的记录。但是如果Session B 中的事务稍后进行了回滚，那么Session A 中的事务相当于读到了一个不存在的数据，这种现象就称之为脏读，就像这个样子</p>
<p><img src="/2020/03/26/8MySQL/4MySQL/image-20200326102522861.png" alt="image-20200326102522861"></p>
<p>脏读违背了现实世界的业务含义，所以这种READ UNCOMMITTED 算是十分不安全的一种隔离级别</p>
<h3 id="已提交读（READ-COMMITTED-RC）"><a href="#已提交读（READ-COMMITTED-RC）" class="headerlink" title="已提交读（READ COMMITTED/RC）"></a>已提交读（READ COMMITTED/RC）</h3><p>不可重复读：一个事务因读取到另一个事务已提交的update。导致对同一条记录读取两次以上的结果不一致</p>
<p>这里有两个重点</p>
<p>如果一个事务只能读到另一个已经提交的事务修改过的数据，并且其他事务每对该数据进行一次修改并提交后，该事务都能查询得到最新值，那么这种隔离级别就称之为已提交读（英文名：READCOMMITTED ），如图所示：</p>
<p><img src="/2020/03/26/8MySQL/4MySQL/image-20200326102709917.png" alt="image-20200326102709917"></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-8MySQL/3MySQL" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2020/03/24/8MySQL/3MySQL/" class="article-date">
      <time datetime="2020-03-24T02:32:20.346Z" itemprop="datePublished">2020-03-24</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="MySQL锁篇"><a href="#MySQL锁篇" class="headerlink" title="MySQL锁篇"></a>MySQL锁篇</h1><h2 id="MySQL锁介绍"><a href="#MySQL锁介绍" class="headerlink" title="MySQL锁介绍"></a>MySQL锁介绍</h2><p><img src="/2020/03/24/8MySQL/3MySQL/image-20200324081447694.png" alt></p>
<h3 id="乐观锁"><a href="#乐观锁" class="headerlink" title="乐观锁"></a>乐观锁</h3><p>用数据版本（Version）记录机制实现，这是乐观锁最常用的一种实现方式。何谓数据版本？</p>
<p>即为数据增加一个版本标识，一般是通过为数据库表增加一个数字类型的 “version” 字段来实现。当读取数据时，将version字段的值一同读出，数据每更新一次，对此version值加1。当我们提交更新的时候，判断数据库表对应记录的当前版本信息与第一次取出来的version值进行比对，如果数据库表当前版本号与第一次取出来的version值相等，则予以更新，否则认为是过期数据</p>
<p><strong>举例</strong></p>
<p>数据库表三个字段，分别是id、value、version</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select id,value,version from TABLE where id = #&#123;id&#125;</span><br></pre></td></tr></table></figure>

<p>每次更新表中的value字段时，为了防止发生冲突，需要这样操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update TABLE set value=2,version=version+1 where id=#&#123;id&#125; and version=#&#123;version&#125;</span><br></pre></td></tr></table></figure>

<h3 id="锁的分类"><a href="#锁的分类" class="headerlink" title="锁的分类"></a>锁的分类</h3><h4 id="按照锁的粒度"><a href="#按照锁的粒度" class="headerlink" title="按照锁的粒度"></a>按照锁的粒度</h4><p>MySQL主要包含三种类型（级别）的锁定机制</p>
<p>全局锁：锁的是整个database。由MySQL的SQL layer层实现的</p>
<p>表级锁：锁的是某个table。由MySQL的SQL layer层实现的</p>
<p>行级锁：锁的是某行数据，也可能锁定行之间的间隙。由某些存储引擎实现，比如InnoDB</p>
<p>表级锁和行级锁的区别</p>
<p>表级锁：开销小，加锁快；不会出现死锁；锁定粒度大，发生锁冲突的概率最高，并发度最低</p>
<p>行级锁：开销大，加锁慢；会出现死锁；锁定粒度最小，发生锁冲突的概率最低，并发度也最高</p>
<h4 id="按照锁的功能"><a href="#按照锁的功能" class="headerlink" title="按照锁的功能"></a>按照锁的功能</h4><p>共享读锁和排他写锁</p>
<h4 id="按照锁的实现方式"><a href="#按照锁的实现方式" class="headerlink" title="按照锁的实现方式"></a>按照锁的实现方式</h4><p>悲观锁和乐观锁（使用某一版本列或者唯一列进行逻辑控制）</p>
<h2 id="MySQL表级锁"><a href="#MySQL表级锁" class="headerlink" title="MySQL表级锁"></a>MySQL表级锁</h2><h3 id="表级锁介绍"><a href="#表级锁介绍" class="headerlink" title="表级锁介绍"></a>表级锁介绍</h3><p>由MySQL SQL layer层实现</p>
<h4 id="MySQL的表级锁有两种"><a href="#MySQL的表级锁有两种" class="headerlink" title="MySQL的表级锁有两种"></a>MySQL的表级锁有两种</h4><p>一种是表锁，一种是元数据锁（meta data lock，MDL)</p>
<h4 id="MySQL-实现的表级锁定的争用状态变量"><a href="#MySQL-实现的表级锁定的争用状态变量" class="headerlink" title="MySQL 实现的表级锁定的争用状态变量"></a>MySQL 实现的表级锁定的争用状态变量</h4> <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">'table%'</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/03/24/8MySQL/3MySQL/image-20200324091556199.png" alt></p>
<p>table_locks_immediate：产生表级锁定的次数</p>
<p>table_locks_waited：出现表级锁定争用而发生等待的次数</p>
<h3 id="表锁介绍"><a href="#表锁介绍" class="headerlink" title="表锁介绍"></a>表锁介绍</h3><p>MySQL允许客户端会话明确获取表锁，以防止其他会话在特定时间段内访问表。客户端会话只能为自己获取或释放表锁。它不能获取或释放其他会话的表锁</p>
<h4 id="表锁有两种表现形式"><a href="#表锁有两种表现形式" class="headerlink" title="表锁有两种表现形式"></a>表锁有两种表现形式</h4><p>表共享读锁（Table Read Lock），表独占写锁（Table Write Lock）</p>
<h4 id="手动增加表锁"><a href="#手动增加表锁" class="headerlink" title="手动增加表锁"></a>手动增加表锁</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOCK TABLES table_name [READ | WRITE];</span><br></pre></td></tr></table></figure>

<p>可将表的名称放在<code>LOCK TABLES</code>关键字后面，后跟一个锁类型。 MySQL提供两种锁类型：<code>READ</code>和<code>WRITE</code></p>
<h4 id="查看表锁情况"><a href="#查看表锁情况" class="headerlink" title="查看表锁情况"></a>查看表锁情况</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show open tables;</span><br></pre></td></tr></table></figure>

<h4 id="删除表锁"><a href="#删除表锁" class="headerlink" title="删除表锁"></a>删除表锁</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unlock tables;</span><br></pre></td></tr></table></figure>

<h3 id="表锁演示"><a href="#表锁演示" class="headerlink" title="表锁演示"></a>表锁演示</h3><h4 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h4><p>新建表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> testdb;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">USE</span> testdb;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tbl (</span><br><span class="line">  <span class="keyword">id</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="keyword">col</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="keyword">id</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h4 id="读锁演示"><a href="#读锁演示" class="headerlink" title="读锁演示"></a>读锁演示</h4><p>表锁定为READ</p>
<p>表的READ锁具有以下功能：</p>
<ul>
<li>同时可以通过多个会话获取表的<code>READ</code>锁。此外，其他会话可以从表中读取数据，而无需获取锁定</li>
<li>持有<code>READ</code>锁的会话只能从表中读取数据，但不能写入。此外，其他会话在释放<code>READ</code>锁之前无法将数据写入表中。来自另一个会话的写操作将被放入等待状态，直到释放<code>READ</code>锁</li>
<li>如果会话正常或异常终止，MySQL将会隐式释放所有锁。这也与<code>WRITE</code>锁相关</li>
</ul>
<p>首先，连接到<code>testdb</code>数据库。要查找当前的连接ID，请使用<code>CONNECTION_ID()</code>函数，如下所示</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT CONNECTION_ID();</span><br><span class="line">+<span class="comment">-----------------+</span></span><br><span class="line">| CONNECTION_ID() |</span><br><span class="line">+<span class="comment">-----------------+</span></span><br><span class="line">|               6 |</span><br><span class="line">+<span class="comment">-----------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>注：</p>
<p>CONNECTION_ID()：MySQL的这个函数返回的是这个连接的连接ID或者thread ID。对于已经建立的连接的客户端，都有一个唯一的连接ID</p>
<p>然后，在向<code>tbl</code>表中插入一个新行</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> tbl(<span class="keyword">col</span>) <span class="keyword">VALUES</span>(<span class="number">10</span>);</span><br></pre></td></tr></table></figure>

<p>接下来，从上表<code>tbl</code>中检索所有行</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM tbl;</span><br><span class="line">+<span class="comment">----+-----+</span></span><br><span class="line">| id | col |</span><br><span class="line">+<span class="comment">----+-----+</span></span><br><span class="line">|  1 |  10 |</span><br><span class="line">+<span class="comment">----+-----+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>之后，要获取锁，可以使用<code>LOCK TABLE</code>语句</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; LOCK TABLES tbl READ;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>最后，在同一个会话中，如果您尝试在<code>tbl</code>表中插入一个新行，将收到一条错误消息</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; INSERT INTO tbl(col) VALUES(11);</span><br><span class="line">ERROR 1099 (HY000): Table 'tbl' was locked <span class="keyword">with</span> a <span class="keyword">READ</span> <span class="keyword">lock</span> <span class="keyword">and</span> can<span class="string">'t be updated</span></span><br></pre></td></tr></table></figure>

<p>所以一旦获得了<code>READ</code>锁定，就不能在同一个会话中的表中写入数据。让我们从不同的会话中来查看<code>READ</code>锁</p>
<p>首先，打开另一个终端并连接到数据库<code>testdb</code>，然后检查连接ID：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT CONNECTION_ID();</span><br><span class="line">+-----------------+</span><br><span class="line">| CONNECTION_ID() |</span><br><span class="line">+-----------------+</span><br><span class="line">|              11 |</span><br><span class="line">+-----------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>然后，从<code>tbl</code>检索数据，如下所示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM tbl;</span><br><span class="line">+----+-----+</span><br><span class="line">| id | col |</span><br><span class="line">+----+-----+</span><br><span class="line">|  1 |  10 |</span><br><span class="line">+----+-----+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>接下来，从第二个会话(会话ID为7)插入一个新行到<code>tbl</code>表中</p>
<p><img src="/2020/03/24/8MySQL/3MySQL/image-20200324130737365.png" alt="image-20200324130737365"></p>
<p>第二个会话的插入操作处于等待状态，因为第一个会话已经在<code>tbl</code>表上获取了一个<code>READ</code>锁，并且尚未释放</p>
<p>可以使用<code>SHOW PROCESSLIST;</code>语句查看详细信息，如下所示</p>
<p><img src="/2020/03/24/8MySQL/3MySQL/image-20200324131019621.png" alt="image-20200324131019621"></p>
<p>之后，返回第一个会话并使用<code>UNLOCK TABLES;</code>语句来释放锁。从第一个会话释放<code>READ</code>锁之后，在第二个会话中执行<code>INSERT</code>操作</p>
<p>最后，查看<code>tbl</code>表中的数据，以查看第二个会话中的<code>INSERT</code>操作是否真的执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM tbl;</span><br><span class="line">+----+-----+</span><br><span class="line">| id | col |</span><br><span class="line">+----+-----+</span><br><span class="line">|  1 |  10 |</span><br><span class="line">|  5 |  12 |</span><br><span class="line">+----+-----+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h4 id="写锁演示"><a href="#写锁演示" class="headerlink" title="写锁演示"></a>写锁演示</h4><p>表锁定WRITE</p>
<p>表锁为<code>WRITE</code>具有以下功能：</p>
<ul>
<li>只有拥有表锁定的会话才能从表读取和写入数据</li>
<li>在释放<code>WRITE</code>锁之前，其他会话不能从表中读写</li>
</ul>
<p>首先，从第一个会话获取一个<code>WRITE</code>锁</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOCK TABLE tbl WRITE;</span><br></pre></td></tr></table></figure>

<p>然后，在<code>tbl</code>表中插入一个新行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO tbl(col) VALUES(14);</span><br></pre></td></tr></table></figure>

<p>没有问题，上面语句可能正常执行。接下来，从<code>tbl</code>表读取数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM tbl;</span><br><span class="line">+----+-----+</span><br><span class="line">| id | col |</span><br><span class="line">+----+-----+</span><br><span class="line">|  1 |  10 |</span><br><span class="line">|  5 |  12 |</span><br><span class="line">|  6 |  14 |</span><br><span class="line">+----+-----+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>之后，打开第二个连接到MySQL的会话，尝试写和读数据</p>
<p><img src="/2020/03/24/8MySQL/3MySQL/image-20200324132340513.png" alt="image-20200324132340513"></p>
<p><img src="/2020/03/24/8MySQL/3MySQL/image-20200324132743428.png" alt="image-20200324132743428"></p>
<p>MySQL将这些操作置于等待状态。可以在第一个会话中，使用<code>SHOW PROCESSLIST;</code>语句来查看它</p>
<p><img src="/2020/03/24/8MySQL/3MySQL/image-20200324132447232.png" alt="image-20200324132447232"></p>
<p>最后，从第一个会话释放锁。执行以下语句</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UNLOCK TABLES;</span><br></pre></td></tr></table></figure>

<p>执行上面语句后，将看到第二个会话中的所有待处理已经执行操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM tbl;</span><br><span class="line">+----+-----+</span><br><span class="line">| id | col |</span><br><span class="line">+----+-----+</span><br><span class="line">|  1 |  10 |</span><br><span class="line">|  5 |  12 |</span><br><span class="line">|  6 |  14 |</span><br><span class="line">|  7 |  20 |</span><br><span class="line">+----+-----+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h3 id="元数据锁介绍"><a href="#元数据锁介绍" class="headerlink" title="元数据锁介绍"></a>元数据锁介绍</h3><p>MDL不需要显式使用，在访问一个表的时候会被自动加上。MDL的作用是，保证读写的正确性。你可以想象一下，如果一个查询正在遍历一个表中的数据，而执行期间另一个线程对这个表结构做变更，删了一列，那么查询线程拿到的结果跟表结构对不上，肯定是不行的</p>
<p>因此，在MySQL 5.5 版本中引入了MDL，当对一个表做增删改查操作的时候，加MDL 读锁，当要对表做结构变更操作的时候，加MDL 写锁</p>
<p>读锁之间不互斥，因此你可以有多个线程同时对一张表增删改查</p>
<p>读写锁之间、写锁之间是互斥的，用来保证变更表结构操作的安全性。因此，如果有两个线程要同时给一个表加字段，其中一个要等另一个执行完才能开始执行</p>
<h4 id="元数据锁演示"><a href="#元数据锁演示" class="headerlink" title="元数据锁演示"></a>元数据锁演示</h4><p><img src="/2020/03/24/8MySQL/3MySQL/image-20200324134431137.png" alt="image-20200324134431137"></p>
<p>session1（Mysql1）、session2（Mysql2）</p>
<p>1、session1</p>
<p>开启事务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">begin;</span><br></pre></td></tr></table></figure>

<p>加MDL读锁</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from tbl;</span><br><span class="line">+----+-----+</span><br><span class="line">| id | col |</span><br><span class="line">+----+-----+</span><br><span class="line">|  1 |  10 |</span><br><span class="line">|  5 |  12 |</span><br><span class="line">|  6 |  14 |</span><br><span class="line">|  7 |  20 |</span><br><span class="line">+----+-----+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>2、session2</p>
<p>修改阻塞</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter table tbl add size int;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/03/24/8MySQL/3MySQL/image-20200324143346439.png" alt="image-20200324143346439"></p>
<p>3、session1</p>
<p>提交事务或者rollback 释放读锁</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">commit;</span><br></pre></td></tr></table></figure>

<p>4、session2</p>
<p>修改完成</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Query OK, 0 rows affected (38.67 sec)  </span><br><span class="line">Records: 0 Duplicates: 0 Warnings: 0</span><br></pre></td></tr></table></figure>

<h3 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h3><h4 id="表读锁"><a href="#表读锁" class="headerlink" title="表读锁"></a>表读锁</h4><p><img src="/2020/03/24/8MySQL/3MySQL/image-20200324144429574.png" alt="image-20200324144429574"></p>
<p>session1（Navicat）、session2（mysql）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1、session1: lock table mylock read; -- 给mylock表加读锁</span><br><span class="line">2、session1: select * from mylock; -- 可以查询</span><br><span class="line">3、session1：select * from tdep; --不能访问非锁定表</span><br><span class="line">4、session2：select * from mylock; -- 可以查询没有锁</span><br><span class="line">5、session2：update mylock set name=&apos;x&apos; where id=2; -- 修改阻塞,自动加行写锁</span><br><span class="line">6、session1：unlock tables; -- 释放表锁</span><br><span class="line">7、session2：Rows matched: 1 Changed: 1 Warnings: 0 -- 修改执行完成</span><br><span class="line">8、session1：select * from tdep; --可以访问</span><br></pre></td></tr></table></figure>

<h4 id="表写锁"><a href="#表写锁" class="headerlink" title="表写锁"></a>表写锁</h4><p><img src="/2020/03/24/8MySQL/3MySQL/image-20200324144526704.png" alt="image-20200324144526704"></p>
<p>session1（Navicat）、session2（mysql）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1、session1: lock table mylock write; -- 给mylock表加写锁</span><br><span class="line">2、session1: select * from mylock; -- 可以查询</span><br><span class="line">3、session1：select * from tdep; --不能访问非锁定表</span><br><span class="line">4、session1：update mylock set name=&apos;y&apos; where id=2; --可以执行</span><br><span class="line">5、session2：select * from mylock; -- 查询阻塞</span><br><span class="line">6、session1：unlock tables; -- 释放表锁</span><br><span class="line">7、session2：4 rows in set (22.57 sec) -- 查询执行完成</span><br><span class="line">8、session1：select * from tdep; --可以访问</span><br></pre></td></tr></table></figure>

<h2 id="MySQL行锁"><a href="#MySQL行锁" class="headerlink" title="MySQL行锁"></a>MySQL行锁</h2><p>InnoDB行锁是通过给索引上的索引项加锁来实现的，因此InnoDB这种行锁实现特点意味着：只有通过索引条件检索的数据，InnoDB才使用行级锁，否则，InnoDB将使用表锁</p>
<h3 id="行锁介绍"><a href="#行锁介绍" class="headerlink" title="行锁介绍"></a>行锁介绍</h3><p>行锁的劣势：开销大；加锁慢；会出现死锁</p>
<p>行锁的优势：锁的粒度小，发生锁冲突的概率低，处理并发的能力强</p>
<p>加锁的方式：自动加锁。对于UPDATE、DELETE和INSERT语句，InnoDB会自动给涉及数据集加排他锁（行写锁），对于普通SELECT语句，InnoDB不会加任何锁</p>
<p>当然我们也可以显式的加锁</p>
<p>共享锁：select * from tableName where … + lock in share more</p>
<p>排他锁：select * from tableName where … + for update</p>
<p>InnoDB和MyISAM的最大不同点有两个</p>
<p>一，InnoDB支持事务(transaction)</p>
<p>二，默认采用行级锁。加锁可以保证事务的一致性，可谓是有人(锁)的地方，就有江湖(事务)</p>
<h3 id="查看行锁状态"><a href="#查看行锁状态" class="headerlink" title="查看行锁状态"></a>查看行锁状态</h3><p><code>show STATUS like &#39;innodb_row_lock%&#39;;</code></p>
<p>Innodb_row_lock_current_waits：当前正在等待锁定的数量</p>
<p>Innodb_row_lock_time：从系统启动到现在锁定总时间长度</p>
<p>Innodb_row_lock_time_avg：每次等待所花平均时间</p>
<p>Innodb_row_lock_time_max：从系统启动到现在等待最常的一次所花的时间</p>
<p>Innodb_row_lock_waits：系统启动后到现在总共等待的次数</p>
<h3 id="行读锁"><a href="#行读锁" class="headerlink" title="行读锁"></a>行读锁</h3><p>session1（Mysql1）、session2（Mysql2）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1、session1: begin;--开启事务未提交</span><br><span class="line">         select * from mylock  where ID=1 lock in share mode; --手动加id=1</span><br><span class="line">的行读锁,使用索引</span><br><span class="line">2、session2：update mylock set name=&apos;y&apos; where id=2; -- 未锁定该行可以修改</span><br><span class="line">3、session2：update mylock set name=&apos;y&apos; where id=1; -- 锁定该行修改阻塞</span><br><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting</span><br><span class="line">transaction  -- 锁定超时</span><br><span class="line">4、session1: commit; --提交事务或者rollback 释放读锁</span><br><span class="line">5、session2：update mylock set name=&apos;y&apos; where id=1; --修改成功</span><br><span class="line">          Query OK, 1 row affected (0.00 sec)</span><br><span class="line">          Rows matched: 1 Changed: 1 Warnings: 0</span><br></pre></td></tr></table></figure>

<p>注：使用索引加行锁，未锁定的行可以访问</p>
<h3 id="行读锁升级为表锁"><a href="#行读锁升级为表锁" class="headerlink" title="行读锁升级为表锁"></a>行读锁升级为表锁</h3><p>session1（Mysql1）、session2（Mysql2）</p>
<p>背景：name列没有加索引</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1、session1: begin;--开启事务未提交</span><br><span class="line">            --手动加name=&apos;c&apos;的行读锁,未使用索引</span><br><span class="line">            select * from mylock  where name=&apos;c&apos; lock in share mode;</span><br><span class="line">2、session2：update mylock set name=&apos;y&apos; where id=2; -- 修改阻塞未用索引行锁升级</span><br><span class="line">为表锁</span><br><span class="line">3、session1: commit; --提交事务或者rollback 释放读锁</span><br><span class="line">4、session2：update mylock set name=&apos;y&apos; where id=2; --修改成功</span><br><span class="line">          Query OK, 1 row affected (0.00 sec)</span><br><span class="line">          Rows matched: 1 Changed: 1 Warnings: 0</span><br></pre></td></tr></table></figure>

<p>注：未使用索引行锁升级为表锁</p>
<h3 id="行写锁"><a href="#行写锁" class="headerlink" title="行写锁"></a>行写锁</h3><p>session1（Mysql1）、session2（Mysql2）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1、session1: begin;--开启事务未提交</span><br><span class="line">            --手动加id=1的行写锁,</span><br><span class="line">            select * from mylock  where id=1 for update;</span><br><span class="line">           </span><br><span class="line">2、session2：select * from mylock  where id=2 ; -- 可以访问</span><br><span class="line">3、session2: select * from mylock  where id=1 ; -- 可以读不加锁 </span><br><span class="line">4、session2: select * from mylock  where id=1 lock in share mode ; --加读锁被阻塞</span><br><span class="line">5、session1：commit; -- 提交事务或者rollback 释放写锁</span><br><span class="line">6、session2：执行成功</span><br></pre></td></tr></table></figure>

<p>注：主键索引产生记录锁</p>
<p>结论：读锁和读锁不冲突，读锁和写锁冲突，带有读锁&amp;写锁这两个任何之一的语句和未加锁的语句是不冲突的</p>
<h3 id="间隙锁"><a href="#间隙锁" class="headerlink" title="间隙锁"></a>间隙锁</h3><p>一般来说，事务的幻读问题，都是通过Seriablizable隔离级别来解决的。但是MySQL使用的间隙锁来解决了，只有在RR（可重复读）隔离级别才会产生间隙锁</p>
<p><img src="/2020/03/24/8MySQL/3MySQL/image-20200324154034728.png" alt="image-20200324154034728"></p>
<p><img src="/2020/03/24/8MySQL/3MySQL/image-20200324154111628.png" alt="image-20200324154111628"></p>
<p><img src="/2020/03/24/8MySQL/3MySQL/image-20200324154123678.png" alt="image-20200324154123678"></p>
<p>间隙锁防止两种情况<br>1、防止插入间隙内的数据</p>
<p>2、防止已有数据更新为间隙内的数据</p>
<p>间隙的范围</p>
<p>update news set number=3 where number=4;</p>
<p>number : 2 3 4</p>
<p>id:1 2 3 4 5</p>
<p>间隙情况：</p>
<p>id、number均在间隙内</p>
<p>id、number均在间隙外</p>
<p>id在间隙内、number在间隙外</p>
<p>id在间隙外，number在间隙内</p>
<p>id、number为边缘数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">案例演示：</span><br><span class="line">mysql&gt; create table news (id int, number int,primary key (id));</span><br><span class="line">mysql&gt; insert into news values(1,2);</span><br><span class="line">......</span><br><span class="line">--加非唯一索引</span><br><span class="line">mysql&gt; alter table news add index idx_num(number);</span><br></pre></td></tr></table></figure>

<p>非唯一索引等值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">-- 非唯一索引的等值</span><br><span class="line">session 1:</span><br><span class="line">start transaction ;</span><br><span class="line">update news set number=3 where number=4;</span><br><span class="line">session 2:</span><br><span class="line">start transaction ;</span><br><span class="line">insert into news value(2,3);#（均在间隙内，阻塞）</span><br><span class="line">insert into news value(7,8);#（均在间隙外，成功）</span><br><span class="line">insert into news value(2,8);#（id在间隙内，number在间隙外，成功）</span><br><span class="line">insert into news value(4,8);#（id在间隙内，number在间隙外，成功）</span><br><span class="line">insert into news value(7,3);#（id在间隙外，number在间隙内，阻塞）</span><br><span class="line">insert into news value(7,2);# (id在间隙外，number为上边缘数据，阻塞)</span><br><span class="line">insert into news value(2,2);#（id在间隙内，number为上边缘数据，阻塞）</span><br><span class="line">insert into news value(7,5);#（id在间隙外，number为下边缘数据，成功）</span><br><span class="line">insert into news value(4,5);#（id在间隙内，number为下边缘数据，阻塞）</span><br></pre></td></tr></table></figure>

<p>结论：只要number（where后面的）在间隙里（2 3 4），不包含最后一个数（5）则不管id是多少都会阻塞</p>
<p>主键索引范围</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--主键索引范围</span></span><br><span class="line">session 1:</span><br><span class="line"><span class="keyword">start</span> <span class="keyword">transaction</span> ;</span><br><span class="line"><span class="keyword">update</span> news <span class="keyword">set</span> <span class="built_in">number</span>=<span class="number">3</span> <span class="keyword">where</span> <span class="keyword">id</span>&gt;<span class="number">1</span> <span class="keyword">and</span> <span class="keyword">id</span> &lt;<span class="number">6</span>;</span><br><span class="line">session 2:</span><br><span class="line"><span class="keyword">start</span> <span class="keyword">transaction</span> ;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> news <span class="keyword">value</span>(<span class="number">2</span>,<span class="number">3</span>);<span class="comment">#（均在间隙内，阻塞）</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> news <span class="keyword">value</span>(<span class="number">7</span>,<span class="number">8</span>);<span class="comment">#（均在间隙外，成功）</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> news <span class="keyword">value</span>(<span class="number">2</span>,<span class="number">8</span>);<span class="comment">#（id在间隙内，number在间隙外，阻塞）</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> news <span class="keyword">value</span>(<span class="number">4</span>,<span class="number">8</span>);<span class="comment">#（id在间隙内，number在间隙外，阻塞）</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> news <span class="keyword">value</span>(<span class="number">7</span>,<span class="number">3</span>);<span class="comment">#（id在间隙外，number在间隙内，成功）</span></span><br><span class="line"><span class="comment">--id无边缘数据，因为主键不能重复</span></span><br></pre></td></tr></table></figure>

<p>结论：只要id（在where后面的）在间隙里(2 4 5)，则不管number是多少都会阻塞。非唯一索引无穷大</p>
<p>session1（Navicat）、session2（mysql）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">--无穷大</span><br><span class="line">session 1:</span><br><span class="line">start transaction ;</span><br><span class="line">update news set number=3 where number=13 ;</span><br><span class="line">session 2:</span><br><span class="line">start transaction ;</span><br><span class="line">insert into news value(11,5);#(执行成功)</span><br><span class="line">insert into news value(12,11);#(执行成功)</span><br><span class="line">insert into news value(14,11);#(阻塞)</span><br><span class="line">insert into news value(15,12);#(阻塞)</span><br><span class="line">检索条件number=13,向左取得最靠近的值11作为左区间，向右由于没有记录因此取得无穷大作为右区</span><br><span class="line">间，因此，session 1的间隙锁的范围（11，无穷大）</span><br><span class="line">结论：id和number同时满足</span><br><span class="line">注：非主键索引产生间隙锁，主键范围产生间隙锁</span><br></pre></td></tr></table></figure>

<h3 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h3><p>两个session 互相等等待对方的资源释放之后，才能释放自己的资源,造成了死锁</p>
<p><img src="/2020/03/24/8MySQL/3MySQL/image-20200324153644093.png" alt="image-20200324153644093"></p>
<p>session1（Navicat）、session2（mysql）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">1、session1: <span class="keyword">begin</span>;<span class="comment">--开启事务未提交</span></span><br><span class="line">            <span class="comment">--手动加行写锁id=1 ，使用索引</span></span><br><span class="line">           <span class="keyword">update</span> mylock <span class="keyword">set</span> <span class="keyword">name</span>=<span class="string">'m'</span> <span class="keyword">where</span> <span class="keyword">id</span>=<span class="number">1</span>;</span><br><span class="line">2、session2：<span class="keyword">begin</span>;<span class="comment">--开启事务未提交</span></span><br><span class="line"><span class="comment">--手动加行写锁id=2 ，使用索引</span></span><br><span class="line">           <span class="keyword">update</span> mylock <span class="keyword">set</span> <span class="keyword">name</span>=<span class="string">'m'</span> <span class="keyword">where</span> <span class="keyword">id</span>=<span class="number">2</span>; </span><br><span class="line">3、session1: <span class="keyword">update</span> mylock <span class="keyword">set</span> <span class="keyword">name</span>=<span class="string">'nn'</span> <span class="keyword">where</span> <span class="keyword">id</span>=<span class="number">2</span>; <span class="comment">-- 加写锁被阻塞</span></span><br><span class="line">4、session2：<span class="keyword">update</span> mylock <span class="keyword">set</span> <span class="keyword">name</span>=<span class="string">'nn'</span> <span class="keyword">where</span> <span class="keyword">id</span>=<span class="number">1</span>; <span class="comment">-- 加写锁会死锁，不允许操作</span></span><br><span class="line">ERROR 1213 (40001): Deadlock found when trying to get <span class="keyword">lock</span>; try</span><br><span class="line">restarting transaction</span><br></pre></td></tr></table></figure>

<h1 id="InnoDB架构分析"><a href="#InnoDB架构分析" class="headerlink" title="InnoDB架构分析"></a>InnoDB架构分析</h1><h2 id="InnoDB架构图"><a href="#InnoDB架构图" class="headerlink" title="InnoDB架构图"></a>InnoDB架构图</h2><p><img src="/2020/03/24/8MySQL/3MySQL/image-20200324165722062.png" alt="image-20200324165722062"></p>
<p><img src="/2020/03/24/8MySQL/3MySQL/image-20200324165733234.png" alt="image-20200324165733234"></p>
<p>上图详细显示了InnoDB存储引擎的体系架构，从图中可见，InnoDB存储引擎由内存池，后台线程和磁盘文件三大部分组成。接下来我们就来简单了解一下内存相关的概念和原理</p>
<h2 id="InnoDB内存结构"><a href="#InnoDB内存结构" class="headerlink" title="InnoDB内存结构"></a>InnoDB内存结构</h2><h3 id="Buﬀer-Pool缓冲池"><a href="#Buﬀer-Pool缓冲池" class="headerlink" title="Buﬀer Pool缓冲池"></a>Buﬀer Pool缓冲池</h3><h4 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h4><p>InnoDB存储引擎是基于磁盘存储的，并将其中的记录按照页的方式进行管理。但是由于CPU速度和磁盘速度之间的鸿沟，基于磁盘的数据库系统通常使用缓冲池记录来提高数据库的的整体性能</p>
<p>所以，缓冲池的大小直接影响着数据库的整体性能，可以通过配置参数innodb_buffer_pool_size来设置</p>
<p>具体来看，缓冲池中缓存的数据页类型有：索引页、数据页、undo页、插入缓冲(insertbuﬀer)、自适应哈希索引(adaptive hash index)、InnoDB存储的锁信息(lock info)和数据字典信息(data dictionary)</p>
<p>物理上是存在一个文件里的，但是逻辑上不是存储在一起</p>
<p>在架构图上可以看到，InnoDB存储引擎的内存区域除了有缓冲池之外，还有重做日志缓冲和额外内存池。InnoDB存储引擎首先将重做日志信息先放到这个缓冲区中，然后按照一定频率将其刷新到重做日志文件中。重做日志缓冲一般不需要设置的很大，该值可由配置参数innodb_log_buffer_size控制</p>
<h4 id="数据页和索引页"><a href="#数据页和索引页" class="headerlink" title="数据页和索引页"></a>数据页和索引页</h4><p>InnoDB存储引擎工作时，需要以Page页为最小单位去将磁盘中的数据加载到内存中，与数据库相关的所有内容都存储在Page结构里。</p>
<p>Page分为几种类型，数据页和索引页就是其中最为重要的两种类型</p>
<h4 id="插入缓冲（Insert-Buﬀer）"><a href="#插入缓冲（Insert-Buﬀer）" class="headerlink" title="插入缓冲（Insert Buﬀer）"></a>插入缓冲（Insert Buﬀer）</h4><p>主要针对次要索引的数据插入存在的问题而设计</p>
<p>我们都知道，在InnoDB引擎上进行插入操作时，一般需要按照主键顺序进行插入，这样才能获得较高的插入性能。当一张表中存在次要索引时，在插入时，数据页的存放还是按照主键进行顺序存放，但是对于次要索引叶节点的插入不再是顺序的了，这时就需要离散的访问次要索引页，由于随机读取的存在导致插入操作性能下降</p>
<p>InnoDB为此设计了Insert Buﬀer来进行插入优化。对于次要索引的插入或者更新操作，不是每一次都直接插入到索引页中，而是先判断插入的非主键索引是否在缓冲池中，若在，则直接插入；若不在，则先放入到一个Insert Buﬀer中。看似数据库这个非主键的索引已经插到叶节点，而实际没有，这时存放在另外一个位置。然后再以一定的频率和情况进行Insert Buﬀer和非聚簇索引页子节点的合并操作。这时通常能够将多个插入合并到一个操作中，这样就大大提高了对于非聚簇索引的插入性能</p>
<h4 id="自适应哈希索引（Adaptive-Hash-Index）"><a href="#自适应哈希索引（Adaptive-Hash-Index）" class="headerlink" title="自适应哈希索引（Adaptive Hash Index）"></a>自适应哈希索引（Adaptive Hash Index）</h4><p>InnoDB会根据访问的频率和模式，为热点页建立哈希索引，来提高查询效率。InnoDB存储引擎会监控对表上各个索引页的查询，如果观察到建立哈希索引可以带来速度上的提升，则建立哈希索引，所以叫做自适应哈希索引</p>
<p>自适应哈希索引是通过缓冲池B+树页构建而来，因此建立速度很快，而且不需要对整张数据表建立哈希索引。其有一个要求，即对这个页的连续访问模式必须是一样的，也就是说其查询的条件（WHERE）必须完全一样，而且必须是连续的</p>
<h4 id="锁信息（Lock-Info）"><a href="#锁信息（Lock-Info）" class="headerlink" title="锁信息（Lock Info）"></a>锁信息（Lock Info）</h4><p>InnoDB存储引擎会在行级别上对表数据进行上锁，不过InnoDB也会在数据库内部其他很多地方使用锁，从而允许对多种不同资源提供并发访问，数据库系统使用锁是为了支持对共享资源进行并发访问，提供数据的完整性和一致性</p>
<h4 id="数据字典信息（Data-Dictionary）"><a href="#数据字典信息（Data-Dictionary）" class="headerlink" title="数据字典信息（Data Dictionary）"></a>数据字典信息（Data Dictionary）</h4><p>InnoDB有自己的表缓存，可以称为表定义缓存或数据字典，当InnoDB打开一张表，就会增加一个对应的对象到数据字典</p>
<p> 数据字典是对数据库中的数据、库对象、表对象等元素的集合。在MySQL中，数据字典信息内容就包括表结构、数据库名或表名、字段的数据类型、视图、索引、表字段信息、存储过程、触发器等内容。</p>
<h3 id="内存数据落盘分析"><a href="#内存数据落盘分析" class="headerlink" title="内存数据落盘分析"></a>内存数据落盘分析</h3><h4 id="整体思路分析"><a href="#整体思路分析" class="headerlink" title="整体思路分析"></a>整体思路分析</h4><p><img src="/2020/03/24/8MySQL/3MySQL/image-20200324185925517.png" alt="image-20200324185925517"></p>
<p>InnoDB内存缓冲池中的数据page要完成持久化的话，是通过两个流程来完成的，一个是脏页落盘，一个是预写<code>redo log</code>日志，这样才能保证数据的可靠性</p>
<p>当缓冲池中的页的版本比磁盘要新时，数据库需要将新版本的页从缓冲池刷新到磁盘。但是如果每次一个页发送变化，就进行刷新，那么性能开发是非常大的，于是InnoDB对于数据文件和日志文件的刷盘遵守了<code>Write AheadLog</code>（WAL）策略和<code>Force Log at Commit</code>两种规则，二者保证了事务的持久性</p>
<p>WAL要求数据的变更写入到磁盘前，首先必须将内存中的日志写入到磁盘，即当事务提交时，先写重做日志，然后再择时将脏读写入磁盘，如果发生宕机导致数据丢失，就通过重做日志进行数据恢复</p>
<p>InnoDB存储引擎会首先将重做日志信息先放入重做日志缓冲中，然后再按照一定频率将其刷新到重做日志文件。重做日志缓冲一般不需要设置得很大，因为一般情况每一秒都会将重做日志缓冲刷新到日志文件中，可通过配置参数<code>innodb_log_buffer_size</code>控制，默认为8MB</p>
<p>除每秒刷新机制之外，每次事务提交时重做日志缓冲也会刷新到日志中。InnoDB是事务的存储引擎，其通过<code>Force-log-at-commit</code>机制实现事务的持久性，即当事务提交时，必须先将该事务的所有日志写入到重做日志文件进行持久化，然后事务的提交操作才算完成</p>
<p>Force-log-at-commit要求当一个事务提交时，所有产生的日志都必须刷新到磁盘上，如果日志刷新成功后，缓冲池中的数据刷新到磁盘前数据库发生了宕机，那么重启时，数据库可以从日志中恢复数据</p>
<p>如上图所示，InnoDB在缓冲池中变更数据时，会首先将相关变更写入重做日志缓冲中，然后再按时或者当事务提交时写入磁盘，这符合Force-log-at-commit原则；当重做日志写入磁盘后，缓冲池中的变更数据才会依据checkpoint机制择时写入到磁盘中，这符合WAL原则。 在checkpoint择时机制中，就有重做日志文件写满的判断。所以，如前文所述，如果重做日志文件太小，经常被写满，就会频繁导致checkpoint将更改的数据写入磁盘，导致性能抖动</p>
<p>为了确保每次日志都写入到重做日志文件，在每次将重做日志缓冲写入重做日志后，必须调用一次fsync操作（操作系统的函数），将缓冲文件从文件系统缓存中真正写入磁盘</p>
<p>可以通过<code>innodb_flush_log_at_trx_commit</code>来控制重做日志刷新到磁盘的策略</p>
<p>该参数的默认值为1，表示事务提交必须进行一次fsync操作（操作系统的函数），还可以设置为0和2</p>
<p>0表示事务提交时不进行写入重做日志操作，该操作只在主线程中完成</p>
<p>2表示提交时写入重做日志，但是之邪入文件系统缓存，不进行fsync操作</p>
<p>由此可见，设置为0时，性能最高，但是丧失了事务的一致性</p>
<p>捋一捋</p>
<p>将数据加载到内存中，是在内存中发生的修改，以page为单位加载到内存中进行存储</p>
<p>磁盘中页中的数据和内存中页的数据不一样的时候，就是脏页</p>
<p>此时就要开始两个流程，一个就是脏页落盘，一个就是预写<code>rudo log</code>日志</p>
<p>为什么要写<code>redo log</code>日志，因为写<code>redo log</code>写入速度很快，它是一种顺序写入，它的作用是先写<code>redo log</code>日志，之后进行脏页落盘，如果在进行脏页落盘的时候发生了宕机数据也不会丢，所以在<code>rudo log</code>日志中存入相应的日志数据</p>
<p>在进行<code>rudo log file</code>的时候先缓存到<code>redo log buffer</code>中，之后一并将<code>redo log buffer</code>中的数据存储到<code>rudo log file</code>中，这样就变相提高写rudo log日志的性能</p>
<p><code>rudo log</code>日志只有在数据丢失的时候才会有用，如果落盘成功的话，<code>redo log</code>日志中相应的内容就可以被清掉</p>
<p>只要事务提交，就强制写入<code>redo log file</code>中</p>
<h4 id="脏页落盘"><a href="#脏页落盘" class="headerlink" title="脏页落盘"></a>脏页落盘</h4><p>在数据库中进行读取操作，将从磁盘中读到的页放在缓冲池中，下次再读相同的页时，首先判断该页是否在缓冲池中。若在缓冲池中，称该页在缓冲池中被命中，直接读取该页。否则，读取磁盘上的页</p>
<p>对于数据库中页的修改操作，则首先修改在缓冲池中的页，然后再以一定的频率刷新到磁盘上。页从缓冲池刷新回磁盘的操作并不是在每次页发生更新时触发，而是通过一种称为CheckPoint的机制刷新回磁盘</p>
<h4 id="重做日志落盘"><a href="#重做日志落盘" class="headerlink" title="重做日志落盘"></a>重做日志落盘</h4><p>InnoDB存储引擎会首先将重做日志信息先放入重做日志缓冲中，然后再按照一定频率将其刷新到重做日志文件。重做日志缓冲一般不需要设置得很大，因为一般情况每一秒钟都会讲重做日志缓冲刷新到日志文件中。可通过配置参数innodb_log_buffer_size控制，默认为8MB</p>
<h3 id="CheckPoint检查点机制"><a href="#CheckPoint检查点机制" class="headerlink" title="CheckPoint检查点机制"></a>CheckPoint检查点机制</h3><h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>思考一下这个场景：如果重做日志可以无限地增大，同时缓冲池也足够大，那么是不需要将缓冲池中页的新版本刷新回磁盘。因为当发生宕机时，完全可以通过重做日志来恢复整个数据库系统中的数据到宕机发生的时刻</p>
<p>但是这需要两个前提条件：1. 缓冲池可以缓存数据库中所有的数据，2. 重做日志可以无限增大</p>
<p>因此Checkpoint（检查点）技术就诞生了，目的是解决以下几个问题</p>
<p>1、缩短数据库的恢复时间</p>
<p>2、缓冲池不够用时，将脏页刷新到磁盘</p>
<p>3、重做日志不可用时，刷新脏页</p>
<p>当数据库发生宕机时，数据库不需要重做所有的日志，因为Checkpoint之前的页都已经刷新回磁盘。数据库只需对Checkpoint后的重做日志进行恢复，这样就大大缩短了恢复的时间</p>
<p>当缓冲池不够用时，根据LRU算法会溢出最近最少使用的页，若此页为脏页，那么需要强制执行Checkpoint，将脏页也就是页的新版本刷回磁盘</p>
<p>当重做日志出现不可用时，因为当前事务数据库系统对重做日志的设计都是循环使用的，并不是让其无限增大的。重做日志可以被重用的部分是指这些重做日志已经不再需要，当数据库发生宕机时，数据库恢复操作不需要这部分的重做日志，因此这部分就可以被覆盖重用。如果重做日志还需要使用，那么必须强制Checkpoint，将缓冲池中的页至少刷新到当前重做日志的位置</p>
<p>对于InnoDB存储引擎而言，是通过LSN（Log Sequence Number）来标记版本的</p>
<p>Checkpoint发生的时间、条件及脏页的选择等都非常复杂。而Checkpoint所做的事情无外乎是将缓冲池中的脏页刷回到磁盘，不同之处在于每次刷新多少页到磁盘，每次从哪里取脏页，以及什么时间触发Checkpoint</p>
<h4 id="Checkpoint分类"><a href="#Checkpoint分类" class="headerlink" title="Checkpoint分类"></a>Checkpoint分类</h4><p>在InnoDB存储引擎内部，有两种Checkpoint，分别为：Sharp Checkpoint、Fuzzy Checkpoint</p>
<p>sharp checkpoint：在关闭数据库的时候，将buﬀer pool中的脏页全部刷新到磁盘中</p>
<p>fuzzy checkpoint：数据库正常运行时，在不同的时机，将部分脏页写入磁盘。仅刷新部分脏页到磁盘，也是为了避免一次刷新全部的脏页造成的性能问题</p>
<p>Fuzzy Checkpoint：</p>
<p>1、Master Thread Checkpoint</p>
<p>在Master Thread中，会以每秒或者每10秒一次的频率，将部分脏页从内存中刷新到磁盘，这个过程是异步的。正常的用户线程对数据的操作不会被阻塞</p>
<p>2、FLUSH_LRU_LIST Checkpoint</p>
<p>FLUSH_LRU_LIST checkpoint是在单独的page cleaner线程中执行的</p>
<p>MySQL对缓存的管理是通过buﬀer pool中的LRU列表实现的，LRU 空闲列表中要保留一定数量的空闲页面，来保证buﬀer pool中有足够的空闲页面来相应外界对数据库的请求</p>
<p>当这个空间页面数量不足的时候，发生FLUSH_LRU_LIST checkpoint</p>
<p>空闲页的数量由innodb_lru_scan_depth参数表来控制的，因此在空闲列表页面数量少于配置的值的时候，会发生checkpoint，剔除部分LRU列表尾端的页面</p>
<p><img src="/2020/03/24/8MySQL/3MySQL/image-20200325201401026.png" alt="image-20200325201401026"></p>
<p>3、Async/Sync Flush Checkpoint</p>
<p>Async/Sync Flush checkpoint是在单独的page cleaner线程中执行的</p>
<p>Async/Sync Flush checkpoint 发生在重做日志不可用的时候，将buﬀer pool中的一部分脏页刷新到磁盘中，在脏页写入磁盘之后，事物对应的重做日志也就可以释放了</p>
<p>关于redo_log文件的的大小，可以通过innodb_log_file_size 来配置</p>
<p>对于是执行Async Flush checkpoint还是Sync Flush checkpoint，由checkpoint_age以及async_water_mark和sync_water_mark来决定</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">##即checkpoint_age等于最新的lsn减去已经刷新到磁盘的lsn的值</span><br><span class="line">checkpoint_age = redo_lsn-checkpoint_lsn</span><br><span class="line">async_water_mark = 75%*innodb_log_file_size</span><br><span class="line">sync_water_mark = 90%*innodb_log_file_size</span><br></pre></td></tr></table></figure>

<ol>
<li>当checkpoint_age&lt;sync_water_mark的时候，无需执行Flush checkpoint。也就说，redo<br>log剩余空间超过25%的时候，无需执行Async/Sync Flush checkpoint</li>
<li>当async_water_mark&lt;checkpoint_age&lt;sync_water_mark的时候，执行Async Flush<br>checkpoint，也就说，redo log剩余空间不足25%，但是大于10%的时候，执行Async Flush<br>checkpoint，刷新到满足条件1</li>
<li>当checkpoint_age&gt;sync_water_mark的时候，执行sync Flush checkpoint。也就说，redo<br>log剩余空间不足10%的时候，执行Sync Flush checkpoint，刷新到满足条件1。<br>在mysql 5.6之后，不管是Async Flush checkpoint还是Sync Flush checkpoint，都不会阻<br>塞用户的查询进程</li>
</ol>
<p>总结</p>
<p>由于磁盘是一种相对较慢的存储设备，内存与磁盘的交互是一个相对较慢的过程由于<code>innodb_log_ﬁle_size</code>定义的是一个相对较大的值，正常情况下，由前面两种<code>checkpoint</code>刷新脏页到磁盘，在前面两种checkpoint刷新脏页到磁盘之后，脏页对应的redo log空间随即释放，一般不会发生Async/Sync Flush checkpoint。同时也要意识到，为了避免频繁低发生Async/SyncFlush checkpoint，也应该将innodb_log_ﬁle_size配置的相对较大一些</p>
<p>4、Dirty Page too much Checkpoint</p>
<p>Dirty Page too much Checkpoint是在Master Thread 线程中每秒一次的频率实现的</p>
<p>Dirty Page too much 意味着buﬀer pool中的脏页过多，执行checkpoint脏页刷入磁盘，保证buﬀer pool中有足够的可用页面</p>
<p>Dirty Page 由innodb_max_dirty_pages_pct配置，innodb_max_dirty_pages_pct的默认值在innodb 1.0之前是90%，之后是75%</p>
<h3 id="Double-Write双写"><a href="#Double-Write双写" class="headerlink" title="Double Write双写"></a>Double Write双写</h3><p>如果说Insert Buﬀer给InnoDB存储引擎带来了性能上的提升，那么Double Write带给InnoDB存储引擎的是数据页的可靠性</p>
<p><img src="/2020/03/24/8MySQL/3MySQL/image-20200325082955488.png" alt="image-20200325082955488"></p>
<p>如上图所示，Double Write由两部分组成，一部分是内存中的double write buﬀer，大小为2MB，另一部分是物理磁盘上共享表空间连续的128个页，大小也为2MB</p>
<p>在对缓冲池的脏页进行刷新时，并不直接写磁盘，而是通过memcpy函数将脏页先复制到内存中的double write buﬀer区域，之后通过double write buﬀer再分两次，每次1MB顺序地写入共享表空间的物理磁盘上，然后马上调用fsync函数，同步磁盘，避免操作系统缓冲写带来的问题。在完成doublewrite页的写入后，再讲double wirite buﬀer中的页写入各个表空间文件中</p>
<p>如果操作系统在将页写入磁盘的过程中发生了崩溃，在恢复过程中，InnoDB存储引擎可以从共享表空间中的double write中找到该页的一个副本，将其复制到表空间文件中，再应用重做日志</p>
<h3 id="Redo-log-Buﬀer重做日志缓冲"><a href="#Redo-log-Buﬀer重做日志缓冲" class="headerlink" title="Redo log Buﬀer重做日志缓冲"></a>Redo log Buﬀer重做日志缓冲</h3><p><img src="/2020/03/24/8MySQL/3MySQL/image-20200325083053080.png" alt="image-20200325083053080"></p>
<p>如上图所示，InnoDB在缓冲池中变更数据时，会首先将相关变更写入重做日志缓冲中，然后再按时或者当事务提交时写入磁盘，这符合Force-log-at-commit原则</p>
<p>当重做日志写入磁盘后，缓冲池中的变更数据才会依据checkpoint机制择时写入到磁盘中，这符合WAL原则</p>
<p>在checkpoint择时机制中，就有重做日志文件写满的判断，所以，如前文所述，如果重做日志文件太小，经常被写满，就会频繁导致checkpoint将更改的数据写入磁盘，导致性能抖动</p>
<p>操作系统的文件系统是带有缓存的，当InnoDB向磁盘写入数据时，有可能只是写入到了文件系统的缓存中，没有真正的“落袋为安”</p>
<p>InnoDB的<code>innodb_ﬂush_log_at_trx_commit</code>属性可以控制每次事务提交时InnoDB的行为</p>
<p>当属性值为0时，事务提交时，不会对重做日志进行写入操作，而是等待主线程按时写入</p>
<p>当属性值为1时，事务提交时，会将重做日志写入文件系统缓存，并且调用文件系统的fsync，将文件系统缓冲中的数据真正写入磁盘存储，确保不会出现数据丢失</p>
<p>当属性值为2时，事务提交时，也会将日志文件写入文件系统缓存，但是不会调用fsync，而是让文件系统自己去判断何时将缓存写入磁盘</p>
<p><code>innodb_ﬂush_log_at_commit</code>是InnoDB性能调优的一个基础参数，涉及InnoDB的写入效率和数据安全。</p>
<p>当参数值为0时，写入效率最高，但是数据安全最低</p>
<p>参数值为1时，写入效率最低，但是数据安全最高</p>
<p>参数值为2时，二者都是中等水平。</p>
<p>一般建议将该属性值设置为1，以获得较高的数据安全性，而且也只有设置为1，才能保证事务的持久性</p>
<p>日志的刷盘机制如下图所示</p>
<p><img src="/2020/03/24/8MySQL/3MySQL/image-20200324165324400.png" alt="image-20200324165324400"></p>
<p>该参数默认值为1<br>可以通过<code>innodb_flush_log_at_trx_commit</code>来控制重做日志刷新到磁盘的策略。该参数默认值为1，表示事务提交必须进行一次fsync操作，还可以设置为0和2。</p>
<p>0表示事务提交时不进行写入重做日志操作，该操作只在主线程中完成</p>
<p>2表示提交时写入重做日志，但是只写入文件系统缓存，不进行fsync操作</p>
<p>由此可见，设置为0时，性能最高，但是丧失了事务的一致性。</p>
<h2 id="InnoDB磁盘文件"><a href="#InnoDB磁盘文件" class="headerlink" title="InnoDB磁盘文件"></a>InnoDB磁盘文件</h2><p>InnoDB的主要的磁盘文件主要分为三大块：一是系统表空间，二是用户表空间，三是redo日志文件和归档文件。二进制文件(binlog)等文件是MySQL Server层维护的文件，所以未列入InnoDB的磁盘文件中</p>
<h3 id="系统表空间和用户表空间"><a href="#系统表空间和用户表空间" class="headerlink" title="系统表空间和用户表空间"></a>系统表空间和用户表空间</h3><p><img src="/2020/03/24/8MySQL/3MySQL/1.png" alt></p>
<p><img src="/2020/03/24/8MySQL/3MySQL/image-20200325153751857.png" alt="image-20200325153751857"></p>
<p>上图显示InnoDB存储引擎对于文件的存储方式，其中frm文件是表结构定义文件，记录每个表的表结构定义</p>
<h4 id="系统表空间存储哪些数据"><a href="#系统表空间存储哪些数据" class="headerlink" title="系统表空间存储哪些数据"></a>系统表空间存储哪些数据</h4><p>系统表空间是一个共享的表空间，因为它是被多个表共享的</p>
<p>InnoDB系统表空间包含InnoDB数据字典(元数据以及相关对象)、double write buﬀer、change buﬀer、undo logs的存储区域</p>
<p>系统表空间也默认包含任何用户在系统表空间创建的表数据和索引数据。系统表空间是一个共享的表空间因为它是被多个表共享的</p>
<p>1、数据字典(data dictionary)：记录数据库相关信息</p>
<p>2、doublewrite write buﬀer：解决部分写失败（页断裂）</p>
<p>3、insert buﬀer：内存insert buﬀer数据，周期写入共享表空间，防止意外宕机</p>
<p>4、回滚段(rollback segments)</p>
<p>5、undo空间：undo页</p>
<p>系统表空间也默认包含任何用户在系统表空间创建的表数据和索引数据</p>
<p>系统表空间是以每个数据库为单位的</p>
<h4 id="系统表空间配置解析"><a href="#系统表空间配置解析" class="headerlink" title="系统表空间配置解析"></a>系统表空间配置解析</h4><p>系统表空间是由一个或者多个数据文件组成</p>
<p>默认情况下，一个初始大小为10MB，名为ibdata1的系统数据文件在MySQL的data目录下被创建。用户可以使用<code>innodb_data_file_path</code>对数据文件的大小和数量进行配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &apos;innodb_data%&apos;;</span><br><span class="line">+-----------------------+------------------------+</span><br><span class="line">| Variable_name         | Value                  |</span><br><span class="line">+-----------------------+------------------------+</span><br><span class="line">| innodb_data_file_path | ibdata1:12M:autoextend |</span><br><span class="line">| innodb_data_home_dir  |                        |</span><br><span class="line">+-----------------------+------------------------+</span><br><span class="line">2 rows in set (0.01 sec)</span><br></pre></td></tr></table></figure>

<p><code>innodb_data_file_path</code> 的格式如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">innodb_data_file_path=datafile1[,datafile2]...</span><br></pre></td></tr></table></figure>

<p>用户可以通过多个文件组成一个表空间，同时制定文件的属性</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">innodb_data_file_path = /db/ibdata1:1000M;/dr2/db/ibdata2:1000M:autoextend</span><br></pre></td></tr></table></figure>

<p>这里将/db/ibdata1和/dr2/db/ibdata2两个文件组成系统表空间</p>
<p>如果这两个文件位于不同的磁盘上，磁盘的负载可能被平均，因此可以提高数据库的整体性能</p>
<p>两个文件的文件名之后都跟了属性，表示文件ibdata1的大小为1000MB，文件ibdata2的大小为1000MB，而且用完空间之后可以自动增长(autoextend)</p>
<p>设置innodb_data_file_path参数之后，所有基于InnoDB存储引擎的表的数据都会记录到该系统表空间中，如果设置了参数innodb_file_per_table，则用户可以将每个基于InnoDB存储引擎的表产生一个独立的用户表空间。用户表空间的命名规则为：表名.ibd。</p>
<p> 通过这种方式，用户不用将所有数据都存放于默认的系统表空间中，但是用户表空间只存储该表的数据、索引和插入缓冲BITMAP等信息，其余信息还是存放在默认的表空间中</p>
<h4 id="注"><a href="#注" class="headerlink" title="注"></a>注</h4><p><code>innodb_data_file_path</code>用来指定innodb tablespace文件，如果我们不在My.cnf文件中指定innodb_data_home_dir和innodb_data_file_path那么默认会在datadir目录下创建ibdata1 作为innodb tablespace</p>
<h4 id="如何使用用户表空间"><a href="#如何使用用户表空间" class="headerlink" title="如何使用用户表空间"></a>如何使用用户表空间</h4><p>如果设置了参数innodb_ﬁle_per_table，则用户可以将每个基于InnoDB存储引擎的表产生一个独立的用户表空间。用户表空间的命名规则为：表名.ibd</p>
<p>通过这种方式，用户不用将所有数据都存放于默认的系统表空间中</p>
<h4 id="用户表空间存储哪些数据"><a href="#用户表空间存储哪些数据" class="headerlink" title="用户表空间存储哪些数据"></a>用户表空间存储哪些数据</h4><p>用户表空间只存储该表的数据、索引和插入缓冲BITMAP等信息，其余信息还是存放在默认的系统表空间中</p>
<p>1、每个表的数据和索引都会存在自已的表空间中</p>
<p>2、每个表的结构</p>
<p>3、undo空间：undo页（需要设置）</p>
<h3 id="重做日志文件和归档文件"><a href="#重做日志文件和归档文件" class="headerlink" title="重做日志文件和归档文件"></a>重做日志文件和归档文件</h3><p><img src="/2020/03/24/8MySQL/3MySQL/2.png" alt></p>
<h4 id="哪些文件是重做日志文件"><a href="#哪些文件是重做日志文件" class="headerlink" title="哪些文件是重做日志文件"></a>哪些文件是重做日志文件</h4><p>默认情况下，在InnoDB存储引擎的数据目录下会有两个名为<code>ib_logﬁle0</code>和<code>ib_logﬁle1</code>的文件，这就是InnoDB的重做日志文件(redo log ﬁle)，它记录了对于InnoDB存储引擎的事务日志</p>
<h4 id="重做日志文件的作用是什么"><a href="#重做日志文件的作用是什么" class="headerlink" title="重做日志文件的作用是什么"></a>重做日志文件的作用是什么</h4><p>当InnoDB的数据存储文件发生错误时，重做日志文件就能派上用场。InnoDB存储引擎可以使用重做日志文件将数据恢复为正确状态，以此来保证数据的正确性和完整性</p>
<p>为了得到更高的可靠性，用户可以设置多个镜像日志组，将不同的文件组放在不同的磁盘上，以此来提高重做日志的高可用性</p>
<h4 id="重做日志文件组是如何写入数据的"><a href="#重做日志文件组是如何写入数据的" class="headerlink" title="重做日志文件组是如何写入数据的"></a>重做日志文件组是如何写入数据的</h4><p>每个InnoDB存储引擎至少有1个重做日志文件组(group)，每个文件组下至少有2个重做日志文件，如默认的<code>ib_logﬁle0</code>和<code>ib_logﬁle1</code></p>
<p>在日志组中每个重做日志文件的大小一致，并以循环写入的方式运行</p>
<p>InnoDB存储引擎先写入重做日志文件1，当文件被写满时，会切换到重做日志文件2，再当重做日志文件2也被写满时，再切换到重做日志文件1</p>
<h4 id="如何设置重做日志文件大小"><a href="#如何设置重做日志文件大小" class="headerlink" title="如何设置重做日志文件大小"></a>如何设置重做日志文件大小</h4><p>用户可以使用<code>innodb_log_ﬁle_size</code>来设置重做日志文件的大小，这对InnoDB存储引擎的性能有着非常大的影响</p>
<p>如果重做日志文件设置的太大，数据丢失时，恢复时可能需要很长的时间</p>
<p>另一方面，如果设置的太小，重做日志文件太小会导致依据checkpoint的检查需要频繁刷新脏页到磁盘中，导致性能的抖动</p>
<h1 id="InnoDB的事务分析"><a href="#InnoDB的事务分析" class="headerlink" title="InnoDB的事务分析"></a>InnoDB的事务分析</h1><p><img src="/2020/03/24/8MySQL/3MySQL/image-20200324191044587.png" alt="image-20200324191044587"></p>
<p>数据库事务具有ACID四大特性。ACID是以下4个词的缩写：</p>
<ul>
<li>原子性(atomicity) ：事务最小工作单元，要么全成功，要么全失败</li>
<li>一致性(consistency)：事务开始和结束后，数据库的完整性不会被破坏</li>
<li>隔离性(isolation) ：不同事务之间互不影响，四种隔离级别为RU（读未提交）、RC（读已提交）、RR（可重复读）、SERIALIZABLE （串行化）</li>
<li>持久性(durability) ：事务提交后，对数据的修改是永久性的，即使系统故障也不会丢失</li>
</ul>
<p>下面我们就来详细讲解一下上述示例涉及的事务的ACID特性的具体实现原理。总结来说，事务的隔离性由多版本控制机制和锁实现，而原子性、一致性和持久性通过InnoDB的redo log、undo log和Force Log at Commit机制来实现</p>
<h2 id="原子性，持久性和一致性"><a href="#原子性，持久性和一致性" class="headerlink" title="原子性，持久性和一致性"></a>原子性，持久性和一致性</h2><p>原子性，持久性和一致性主要是通过<code>redo log</code>、<code>undo log</code>和<code>Force Log at Commit</code>机制机制来完成的。redo log用于在崩溃时恢复数据，undo log用于对事务的影响进行撤销，也可以用于多版本控制。而Force Log at Commit机制保证事务提交后redo log日志都已经持久化</p>
<h3 id="RedoLog"><a href="#RedoLog" class="headerlink" title="RedoLog"></a>RedoLog</h3><p>数据库日志和数据落盘机制，如下图所示</p>
<p><img src="/2020/03/24/8MySQL/3MySQL/image-20200324191302065.png" alt="image-20200324191302065"></p>
<p>redo log写入磁盘时，必须进行一次操作系统的fsync操作，防止redo log只是写入了操作系统的磁盘缓存中。参数innodb_ﬂush_log_at_trx_commit可以控制redo log日志刷新到磁盘的策略</p>
<h3 id="UndoLog"><a href="#UndoLog" class="headerlink" title="UndoLog"></a>UndoLog</h3><p>UndoLog没有专门存储成一个文件，它存储到系统表空间里，UndoLog有两个作用，一个是用来做事务回滚，一个是用来做MVCC的版本记录</p>
<p>UndoLog中分为两类进行存储</p>
<p>insert undolog：做insert插入操作时，产生的回滚日志</p>
<p>update undolog：做delete和update操作时，产生的回滚日志</p>
<p>undolog没有单独的文件，而是存储到系统表空间中的（ibdata1）</p>
<p>数据库崩溃重启后需要从redo log中把未落盘的脏页数据恢复出来，重新写入磁盘，保证用户的数据不丢失。当然，在崩溃恢复中还需要回滚没有提交的事务。由于回滚操作需要undo日志的支持，undo日志的完整性和可靠性需要redo日志来保证，所以崩溃恢复先做redo恢复数据，然后做undo回滚</p>
<p><img src="/2020/03/24/8MySQL/3MySQL/image-20200324191417286.png" alt="image-20200324191417286"></p>
<p>在事务执行的过程中，除了记录redo log，还会记录一定量的undo log。undo log记录了数据在每个操作前的状态，如果事务执行过程中需要回滚，就可以根据undo log进行回滚操作</p>
<p><img src="/2020/03/24/8MySQL/3MySQL/image-20200324191431981.png" alt="image-20200324191431981"></p>
<p>事前准备</p>
<p>第一种其实没有加锁，串行化就是读写都加锁，中间两种是mvcc，即 读不加锁写加锁</p>
<p>聚集索引和非聚集索引</p>
<p>主键索引是聚集索引，辅助索引是非聚集索引</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/3/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2019-2020 爱吃鱼的呆先生
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减 Hexo 双栏博客主题  v3.5">Yelee</a> by MOxFIVE <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" title="本站到访数"><i class="fa fa-user" aria-hidden="true"></i><span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>| </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit"  title="本页阅读量"><i class="fa fa-eye animated infinite pulse" aria-hidden="true"></i><span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>
    </div>
    
<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 5;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>





<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
            
            
            
            
            
            
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>